<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarkov Raid Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 900px; margin-top: 50px; }
        
        /* Karten-Stil fÃ¼r Quests */
        .quest-item {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .quest-item:hover { background-color: #252525; border-color: #555; }
        
        /* Wenn ausgewÃ¤hlt */
        .quest-item.selected {
            background-color: #2c3e50;
            border-color: #f1c40f;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.2);
        }

        .form-check-input { transform: scale(1.3); margin-right: 15px; cursor: pointer; }
        .trader-badge { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; color: #aaa; }
        
        /* Planungs-Box */
        #planning-result { display: none; background: #222; border: 1px solid #444; padding: 20px; border-radius: 10px; margin-top: 30px; }
        .key-tag { background-color: #c0392b; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.9em; margin-right: 5px; }
        .item-tag { background-color: #2980b9; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.9em; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container pb-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-warning">Tarkov Raid Planner</h1>
        <p class="lead text-light">WÃ¤hle deine aktiven Quests und plane den perfekten Run.</p>
    </div>

    <div class="row g-2 mb-4 justify-content-center">
        <div class="col-md-4">
            <select id="mapSelect" class="form-select form-select-lg bg-dark text-light border-secondary">
                <option value="Customs">Customs</option>
                <option value="Factory">Factory</option>
                <option value="Woods">Woods</option>
                <option value="Interchange">Interchange</option>
                <option value="Shoreline">Shoreline</option>
                <option value="Reserve">Reserve</option>
                <option value="Lighthouse">Lighthouse</option>
                <option value="Streets of Tarkov">Streets</option>
                <option value="Ground Zero">Ground Zero</option>
            </select>
        </div>
        <div class="col-md-3">
            <button onclick="loadQuests()" class="btn btn-warning btn-lg w-100 fw-bold">1. Quests laden</button>
        </div>
    </div>

    <div id="error-box" class="alert alert-danger d-none"></div>

    <div id="loading" class="text-center d-none my-5">
        <div class="spinner-border text-warning" role="status"></div>
        <p class="mt-2">Hole Daten aus Tarkov...</p>
    </div>

    <div id="quest-selection-area" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-light">VerfÃ¼gbare Quests <small class="text-muted">(Klick zum AuswÃ¤hlen)</small></h4>
            <button onclick="planRaid()" class="btn btn-success btn-lg px-5 fw-bold">2. RAID PLANEN ðŸš€</button>
        </div>
        <div id="quest-list">
            </div>
    </div>

    <div id="planning-result">
        <h2 class="text-warning border-bottom border-secondary pb-2 mb-4">Dein Schlachtplan</h2>
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <h5 class="text-danger fw-bold">ðŸ”‘ BenÃ¶tigte SchlÃ¼ssel</h5>
                <div id="required-keys" class="d-flex flex-wrap gap-2 text-muted">Keine SchlÃ¼ssel benÃ¶tigt.</div>
            </div>
            <div class="col-md-6 mb-4">
                <h5 class="text-info fw-bold">ðŸŽ’ Items (Finden/Platzieren)</h5>
                <div id="required-items" class="d-flex flex-wrap gap-2 text-muted">Keine Items.</div>
            </div>
        </div>

        <h5 class="text-light fw-bold mt-2">ðŸŽ¯ Missionsziele (Ãœbersicht)</h5>
        <ul id="mission-steps" class="list-group list-group-flush bg-transparent">
            </ul>
    </div>

</div>

<script>
    const API_URL = "/api";
    let loadedQuests = []; // Hier speichern wir alle Daten zwischen

    async function loadQuests() {
        const map = document.getElementById('mapSelect').value;
        const listContainer = document.getElementById('quest-list');
        const selectionArea = document.getElementById('quest-selection-area');
        const errorBox = document.getElementById('error-box');
        const loader = document.getElementById('loading');
        const resultBox = document.getElementById('planning-result');

        // Reset
        errorBox.classList.add('d-none');
        resultBox.style.display = 'none';
        listContainer.innerHTML = '';
        selectionArea.classList.add('d-none');
        loader.classList.remove('d-none');
        loadedQuests = [];

        try {
            const response = await fetch(`${API_URL}/quests/${map}`, {
                method: 'GET',
                credentials: 'include'
            });

            if (!response.ok) throw new Error(`Server Fehler: ${response.status}`);
            
            const quests = await response.json();
            
            if (!Array.isArray(quests)) {
                throw new Error("UngÃ¼ltiges Datenformat empfangen.");
            }

            loadedQuests = quests; // Daten speichern!

            if (quests.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-muted p-5">Keine Quests fÃ¼r diese Map gefunden.</div>';
            } else {
                // Liste bauen
                quests.forEach((quest, index) => {
                    const div = document.createElement('div');
                    div.className = 'quest-item d-flex align-items-center';
                    // Klick-Event fÃ¼r die ganze Box
                    div.onclick = (e) => toggleSelection(index, div, e);

                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" id="q-${index}" onchange="event.stopPropagation(); toggleSelection(${index}, this.parentElement, event)">
                        <div class="ms-3 flex-grow-1">
                            <h5 class="m-0 fw-bold">${quest.name}</h5>
                            <span class="trader-badge">${quest.trader.name}</span>
                            ${quest.minPlayerLevel ? `<span class="badge bg-secondary ms-2">Lvl ${quest.minPlayerLevel}</span>` : ''}
                        </div>
                        <a href="${quest.wikiLink}" target="_blank" class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation()">Wiki</a>
                    `;
                    listContainer.appendChild(div);
                });
            }
            selectionArea.classList.remove('d-none');

        } catch (error) {
            errorBox.textContent = "Fehler: " + error.message;
            errorBox.classList.remove('d-none');
        } finally {
            loader.classList.add('d-none');
        }
    }

    function toggleSelection(index, divElement, event) {
        // Logik damit man auf die Box klicken kann, nicht nur Checkbox
        const checkbox = document.getElementById(`q-${index}`);
        
        // Wenn Klick nicht direkt auf Checkbox war, Status Ã¤ndern
        if (event.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
        }

        // Visuelles Feedback
        if (checkbox.checked) {
            divElement.classList.add('selected');
        } else {
            divElement.classList.remove('selected');
        }
    }

    function planRaid() {
        const resultBox = document.getElementById('planning-result');
        const keysContainer = document.getElementById('required-keys');
        const itemsContainer = document.getElementById('required-items');
        const stepsContainer = document.getElementById('mission-steps');
        
        // 1. Welche Quests sind ausgewÃ¤hlt?
        const selectedIndices = [];
        loadedQuests.forEach((_, index) => {
            if (document.getElementById(`q-${index}`).checked) {
                selectedIndices.push(index);
            }
        });

        if (selectedIndices.length === 0) {
            alert("Bitte wÃ¤hle mindestens eine Quest aus!");
            return;
        }

        // 2. Daten sammeln
        const neededKeys = new Set();
        const neededItems = [];
        const objectives = [];

        selectedIndices.forEach(index => {
            const quest = loadedQuests[index];
            
            // Keys sammeln
            if (quest.neededKeys) {
                quest.neededKeys.forEach(kGroup => {
                    // Nimm den ersten Key aus der Gruppe (meist gibt es Alternativen, wir zeigen den ersten)
                    if(kGroup.keys && kGroup.keys.length > 0) {
                        neededKeys.add(kGroup.keys[0].name);
                    }
                });
            }

            // Objectives verarbeiten
            if (quest.objectives) {
                quest.objectives.forEach(obj => {
                    objectives.push({
                        quest: quest.name,
                        desc: obj.description,
                        type: obj.type
                    });
                    
                    // Items sammeln (Found in Raid etc)
                    if (obj.type === 'GiveItem' && obj.item) {
                        neededItems.push(`${obj.count}x ${obj.item.name}`);
                    }
                });
            }
        });

        // 3. Ergebnis anzeigen
        
        // Keys
        keysContainer.innerHTML = neededKeys.size > 0 
            ? Array.from(neededKeys).map(k => `<span class="key-tag">ðŸ”‘ ${k}</span>`).join('') 
            : '<span class="text-success">Keine SchlÃ¼ssel notwendig! Freie Fahrt.</span>';

        // Items
        itemsContainer.innerHTML = neededItems.length > 0 
            ? neededItems.map(i => `<span class="item-tag">ðŸ“¦ ${i}</span>`).join('') 
            : '<span class="text-muted">-</span>';

        // Missionsziele auflisten
        stepsContainer.innerHTML = objectives.map(obj => `
            <li class="list-group-item bg-transparent text-light border-secondary">
                <strong class="text-warning">${obj.quest}:</strong> ${obj.desc}
            </li>
        `).join('');

        // Anzeigen
        resultBox.style.display = 'block';
        // Automatisch nach unten scrollen
        resultBox.scrollIntoView({ behavior: 'smooth' });
    }
</script>

</body>
</html>