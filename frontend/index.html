<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarkov Raid Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f0f0f; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1000px; margin-top: 40px; }
        
        /* Quest Item Styling */
        .quest-item {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            margin-bottom: 8px;
            padding: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .quest-item:hover { background-color: #252525; border-color: #555; }
        .quest-item.selected {
            background-color: #2c3e50;
            border-color: #f39c12;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.3);
        }

        .form-check-input { transform: scale(1.3); margin-right: 15px; cursor: pointer; }
        .trader-badge { font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-right: 10px; }
        
        /* Result Box Styling */
        #planning-result { display: none; background: #161616; border: 1px solid #333; padding: 25px; border-radius: 12px; margin-top: 30px; margin-bottom: 50px;}
        
        /* Icons styling */
        .key-icon { width: 40px; height: 40px; object-fit: contain; margin-right: 8px; }
        .item-badge { background-color: #222; border: 1px solid #444; padding: 5px 10px; border-radius: 6px; display: inline-flex; align-items: center; margin: 5px; }
        
        /* Map Container */
        .map-container {
            width: 100%;
            height: 600px;
            background-color: #050505;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .map-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            display: block;
        }
        /* Fallback Text falls Bild fehlt */
        .map-fallback-text {
            position: absolute;
            color: #555;
            font-size: 1.2rem;
            display: none;
        }
    </style>
</head>
<body>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-bold text-warning mb-0">Tarkov Raid Planner <span class="badge bg-success fs-6 align-middle">v1.2 (Stable)</span></h1>
            <p class="text-secondary m-0">Select your active tasks and optimize your route.</p>
        </div>
        <div id="status-badge" class="badge bg-dark text-muted border border-secondary">System Ready</div>
    </div>

    <div class="card bg-dark border-secondary mb-4">
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="text-muted small mb-1">Select Location</label>
                    <select id="mapSelect" class="form-select bg-black text-light border-secondary">
                        <option value="Customs">Customs</option>
                        <option value="Factory">Factory</option>
                        <option value="Woods">Woods</option>
                        <option value="Interchange">Interchange</option>
                        <option value="Shoreline">Shoreline</option>
                        <option value="Reserve">Reserve</option>
                        <option value="Lighthouse">Lighthouse</option>
                        <option value="Streets of Tarkov">Streets of Tarkov</option>
                        <option value="Ground Zero">Ground Zero</option>
                        <option value="Labs">The Lab</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button onclick="loadQuests()" class="btn btn-warning w-100 fw-bold">Load Quests</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center d-none my-5">
        <div class="spinner-border text-warning" role="status"></div>
        <p class="mt-2 text-muted">Fetching Intel from Tarkov servers...</p>
    </div>
    
    <div id="error-box" class="alert alert-danger d-none"></div>

    <div id="quest-selection-area" class="d-none">
        <div class="d-flex justify-content-between align-items-end mb-3">
            <h5 class="text-light m-0">Available Operations</h5>
            <button onclick="planRaid()" class="btn btn-success fw-bold px-4">PLAN RAID üöÄ</button>
        </div>
        <div id="quest-list"></div>
    </div>

    <div id="planning-result">
        
        <h4 class="text-warning mb-3">üìç Tactical Map</h4>
        <div class="map-container">
            <img id="map-display" src="" class="map-image" alt="Map Preview" onerror="this.onerror=null; this.style.display='none'; document.getElementById('map-fallback').style.display='block';">
            <div id="map-fallback" class="map-fallback-text">Map image unavailable</div>
            
            <div class="position-absolute bottom-0 end-0 p-2 bg-black bg-opacity-75 text-white small">
                Source: TarkovTracker / Wiki
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <h5 class="text-danger border-bottom border-danger pb-2 mb-3">üîë Required Keys</h5>
                <div id="required-keys" class="d-flex flex-wrap"></div>
            </div>
            
            <div class="col-md-6">
                <h5 class="text-info border-bottom border-info pb-2 mb-3">üéí Loot / Place Items</h5>
                <div id="required-items" class="d-flex flex-wrap"></div>
            </div>
        </div>

        <h5 class="text-light border-bottom border-secondary pb-2 mb-3 mt-4">üìù Mission Objectives</h5>
        <ul id="mission-steps" class="list-group list-group-flush"></ul>
    </div>
</div>

<script>
    const API_URL = "/api";
    let loadedQuests = [];

    // Map Images - Using multiple sources for stability
    const MAP_IMAGES = {
        "Customs": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/customs-2d.jpg",
        "Factory": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/factory-3d.jpg",
        "Woods": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/woods-2d.jpg",
        "Interchange": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/interchange-2d.jpg",
        "Shoreline": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/shoreline-2d.jpg",
        "Reserve": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/reserve-2d.jpg",
        "Lighthouse": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/lighthouse-2d-expansion.jpg",
        "Streets of Tarkov": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/streets-2d.jpg",
        "Ground Zero": "https://static.wikia.nocookie.net/escapefromtarkov_gamepedia/images/3/3d/GroundZero_Map_Re3mr.jpg", 
        "Labs": "https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/maps/labs-2d.jpg"
    };

    async function loadQuests() {
        const mapSelect = document.getElementById('mapSelect');
        const map = mapSelect.value;
        const listContainer = document.getElementById('quest-list');
        const selectionArea = document.getElementById('quest-selection-area');
        const errorBox = document.getElementById('error-box');
        const loader = document.getElementById('loading');
        const resultBox = document.getElementById('planning-result');

        // Reset UI
        errorBox.classList.add('d-none');
        resultBox.style.display = 'none';
        listContainer.innerHTML = '';
        selectionArea.classList.add('d-none');
        loader.classList.remove('d-none');
        
        try {
            const response = await fetch(`${API_URL}/quests/${map}`, { method: 'GET' });
            if (!response.ok) throw new Error(`Server Error: ${response.status} - Check Backend Logs`);
            
            const quests = await response.json();
            loadedQuests = quests;

            if (quests.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-muted p-4">No active quests found for this map.</div>';
            } else {
                quests.forEach((quest, index) => {
                    const div = document.createElement('div');
                    div.className = 'quest-item d-flex align-items-center';
                    div.onclick = (e) => toggleSelection(index, div, e);
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" id="q-${index}" onchange="event.stopPropagation(); toggleSelection(${index}, this.parentElement, event)">
                        <div class="ms-3 flex-grow-1">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold text-light">${quest.name}</span>
                                ${quest.wikiLink ? `<a href="${quest.wikiLink}" target="_blank" class="ms-2 text-muted small" onclick="event.stopPropagation()">[Wiki]</a>` : ''}
                            </div>
                            <div class="mt-1">
                                <span class="trader-badge">üë§ ${quest.trader.name}</span>
                                <span class="text-secondary small">Lvl ${quest.minPlayerLevel}</span>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
            selectionArea.classList.remove('d-none');

        } catch (error) {
            errorBox.textContent = "Error: " + error.message;
            errorBox.classList.remove('d-none');
        } finally {
            loader.classList.add('d-none');
        }
    }

    function toggleSelection(index, divElement, event) {
        const checkbox = document.getElementById(`q-${index}`);
        if (event.target !== checkbox && event.target.tagName !== 'A') {
            checkbox.checked = !checkbox.checked;
        }
        if (checkbox.checked) divElement.classList.add('selected');
        else divElement.classList.remove('selected');
    }

    function planRaid() {
        const resultBox = document.getElementById('planning-result');
        const keysContainer = document.getElementById('required-keys');
        const itemsContainer = document.getElementById('required-items');
        const stepsContainer = document.getElementById('mission-steps');
        const mapDisplay = document.getElementById('map-display');
        const mapFallback = document.getElementById('map-fallback');
        const mapName = document.getElementById('mapSelect').value;

        // Reset map display state
        mapDisplay.style.display = 'block';
        mapFallback.style.display = 'none';

        // 1. Load Map
        if (MAP_IMAGES[mapName]) {
            mapDisplay.src = MAP_IMAGES[mapName];
        } else {
            // No map URL defined
            mapDisplay.style.display = 'none';
            mapFallback.style.display = 'block';
        }

        // 2. Gather Selected Data
        const selectedIndices = [];
        loadedQuests.forEach((_, index) => {
            if (document.getElementById(`q-${index}`).checked) selectedIndices.push(index);
        });

        if (selectedIndices.length === 0) {
            alert("Please select at least one quest!");
            return;
        }

        const neededKeys = new Map(); 
        const neededItems = [];
        const objectives = [];

        selectedIndices.forEach(index => {
            const quest = loadedQuests[index];
            
            // Collect Keys
            if (quest.neededKeys) {
                quest.neededKeys.forEach(kGroup => {
                    if(kGroup.keys && kGroup.keys.length > 0) {
                        const k = kGroup.keys[0];
                        neededKeys.set(k.name, k); 
                    }
                });
            }

            // Collect Objectives
            if (quest.objectives) {
                quest.objectives.forEach(obj => {
                    objectives.push({ quest: quest.name, desc: obj.description });
                    if (obj.type === 'GiveItem' && obj.item) {
                        neededItems.push({ 
                            name: obj.item.name, 
                            count: obj.count, 
                            icon: obj.item.iconLink 
                        });
                    }
                });
            }
        });

        // 3. Render Keys
        keysContainer.innerHTML = neededKeys.size > 0 
            ? Array.from(neededKeys.values()).map(k => `
                <div class="item-badge" title="${k.name}">
                    ${k.iconLink ? `<img src="${k.iconLink}" class="key-icon">` : 'üîë'}
                    <span>${k.shortName || k.name}</span>
                </div>
              `).join('') 
            : '<span class="text-success p-2">No special keys required.</span>';

        // 4. Render Items
        itemsContainer.innerHTML = neededItems.length > 0 
            ? neededItems.map(i => `
                <div class="item-badge">
                    ${i.icon ? `<img src="${i.icon}" class="key-icon">` : 'üì¶'}
                    <span>${i.count}x ${i.name}</span>
                </div>
              `).join('') 
            : '<span class="text-muted p-2">-</span>';

        // 5. Render Mission Log
        stepsContainer.innerHTML = objectives.map(obj => `
            <li class="list-group-item bg-transparent text-light border-secondary">
                <span class="text-warning fw-bold">${obj.quest}:</span> ${obj.desc}
            </li>
        `).join('');

        resultBox.style.display = 'block';
        resultBox.scrollIntoView({ behavior: 'smooth' });
    }
</script>

</body>
</html>