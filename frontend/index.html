<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarkov Quest Helper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>

    <style>
        body { background-color: #0f0f0f; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1200px; margin-top: 40px; }
        
        /* Quest Styling */
        .quest-item {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            margin-bottom: 8px;
            padding: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .quest-item:hover { background-color: #252525; border-color: #555; }
        .quest-item.selected {
            background-color: #2c3e50;
            border-color: #f39c12;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.3);
        }

        /* Accordion Styling (Gruppen) */
        .accordion-item { background-color: transparent; border: 1px solid #333; margin-bottom: 8px; }
        .accordion-button { background-color: #161616; color: #e0e0e0; font-weight: bold; }
        .accordion-button:not(.collapsed) { background-color: #2c2c2c; color: #f39c12; box-shadow: none; }
        .accordion-button::after { filter: invert(1); }
        .accordion-body { background-color: #0f0f0f; padding: 10px; }

        .form-check-input { transform: scale(1.3); margin-right: 15px; cursor: pointer; }
        .trader-badge { font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-right: 10px; }
        
        #planning-result { display: none; background: #161616; border: 1px solid #333; padding: 25px; border-radius: 12px; margin-top: 30px; margin-bottom: 50px;}
        
        .key-icon { width: 40px; height: 40px; object-fit: contain; margin-right: 8px; }
        .item-badge { background-color: #222; border: 1px solid #444; padding: 5px 10px; border-radius: 6px; display: inline-flex; align-items: center; margin: 5px; }
        
        /* Neue Status Farben f√ºr Items */
        .item-badge.provided { border-color: #27ae60; background-color: #1e3a2a; color: #a8e6cf; }
        .item-badge.acquire { border-color: #d35400; background-color: #3a2216; color: #edc2a8; }
        
        .map-container {
            width: 100%;
            height: 600px;
            background-color: #050505;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
            border: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
        }
        .map-image { max-width: 100%; max-height: 100%; object-fit: contain; display: block; cursor: grab; transition: none; }
        .map-image:active { cursor: grabbing; }
        .map-controls { position: absolute; bottom: 20px; right: 20px; z-index: 100; display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 8px; }
        .map-btn { width: 35px; height: 35px; border: 1px solid #555; background: #222; color: #fff; border-radius: 4px; cursor: pointer; }
        .map-btn:hover { background: #444; }
    </style>
</head>
<body>

<div class="container pb-5">
    <div class="mb-5">
        <h1 class="fw-bold text-warning mb-0">Tarkov Quest Helper <span class="badge bg-secondary fs-6 align-middle">v1.0 (Alpha)</span></h1>
        <p class="text-secondary m-0">Optimize your route. Grouped Tasks & Resource Management.</p>
    </div>

    <div class="card bg-dark border-secondary mb-4">
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="text-muted small mb-1">Select Location</label>
                    <select id="mapSelect" class="form-select bg-black text-light border-secondary">
                        <option value="Customs">Customs</option>
                        <option value="Factory">Factory</option>
                        <option value="Woods">Woods</option>
                        <option value="Interchange">Interchange</option>
                        <option value="Shoreline">Shoreline</option>
                        <option value="Reserve">Reserve</option>
                        <option value="Lighthouse">Lighthouse</option>
                        <option value="Streets of Tarkov">Streets of Tarkov</option>
                        <option value="Ground Zero">Ground Zero</option>
                        <option value="Labs">The Lab</option>
                        <option value="Any">Any Location / Global</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button onclick="loadQuests()" class="btn btn-warning w-100 fw-bold">Load Quests</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center d-none my-5">
        <div class="spinner-border text-warning" role="status"></div>
        <p class="mt-2 text-muted">Retrieving Intel...</p>
    </div>
    <div id="error-box" class="alert alert-danger d-none"></div>

    <div id="quest-selection-area" class="d-none">
        <div class="d-flex justify-content-between align-items-end mb-3">
            <h5 class="text-light m-0">Available Operations</h5>
            <div>
                <button onclick="clearSelection()" class="btn btn-outline-danger me-2 btn-sm">Reset</button>
                <button onclick="planRaid()" class="btn btn-success fw-bold px-4">PLAN RAID üöÄ</button>
            </div>
        </div>
        <div id="quest-list" class="accordion" id="questAccordion"></div>
    </div>

    <div id="planning-result">
        <h4 class="text-warning mb-3">üìç Tactical Map</h4>
        <div class="map-container" id="map-container-div">
            <img id="map-display" src="" class="map-image" alt="Map Preview" onerror="handleMapError()">
            <div class="map-controls" id="map-controls">
                <button class="map-btn" id="zoom-in">+</button>
                <button class="map-btn" id="zoom-out">-</button>
                <button class="map-btn" id="zoom-reset">‚Ü∫</button>
            </div>
            <div id="map-fallback-link" class="text-center" style="display:none; position:absolute; margin-top:10px;">
                <p class="text-muted" id="map-fallback-text">No local map.</p>
                <a id="ext-map-link" href="#" target="_blank" class="btn btn-outline-warning btn-sm">Open Web Map ‚ÜóÔ∏è</a>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <h5 class="text-danger border-bottom border-danger pb-2 mb-3">üîë Required Keys</h5>
                <div id="required-keys" class="d-flex flex-wrap"></div>
            </div>
            
            <div class="col-md-6">
                <h5 class="text-info border-bottom border-info pb-2 mb-3">üéí Required Items</h5>
                <p class="small text-muted mb-2">Check if items are provided on quest start or need to be acquired.</p>
                <div id="required-items" class="d-flex flex-wrap"></div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-7">
                <h5 class="text-light border-bottom border-secondary pb-2 mb-3">üìù Objectives</h5>
                <ul id="mission-steps" class="list-group list-group-flush"></ul>
            </div>
            <div class="col-md-5">
                <h5 class="text-purple border-bottom border-secondary pb-2 mb-3" style="color: #a29bfe;">üîÆ Future Unlocks</h5>
                <div id="progression-list" class="small"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "/api";
    const STORAGE_KEY = "tarkov_planner_selected_quests"; 
    let loadedQuests = [];
    let panzoomInstance = null; 

    // Config
    const MAP_CONFIG = {
        "Customs": { file: "customs.jpg", url: "https://tarkov.dev/map/customs-2d" },
        "Factory": { file: "factory.jpg", url: "https://tarkov.dev/map/factory-3d" },
        "Woods": { file: "woods.jpg", url: "https://tarkov.dev/map/woods-2d" },
        "Interchange": { file: "interchange.jpg", url: "https://tarkov.dev/map/interchange-2d" },
        "Shoreline": { file: "shoreline.jpg", url: "https://tarkov.dev/map/shoreline-2d" },
        "Reserve": { file: "reserve.jpg", url: "https://tarkov.dev/map/reserve-2d" },
        "Lighthouse": { file: "lighthouse.jpg", url: "https://tarkov.dev/map/lighthouse-2d" },
        "Streets of Tarkov": { file: "streets.jpg", url: "https://tarkov.dev/map/streets-2d" },
        "Ground Zero": { file: "groundzero.jpg", url: "https://tarkov.dev/map/ground-zero-2d" },
        "Labs": { file: "labs.jpg", url: "https://tarkov.dev/map/the-lab-2d" }
    };

    function getSavedQuests() {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? new Set(JSON.parse(saved)) : new Set();
    }
    function saveQuestState(questId, isChecked) {
        const savedSet = getSavedQuests();
        if (isChecked) savedSet.add(questId); else savedSet.delete(questId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify([...savedSet]));
    }
    function clearSelection() {
        if(confirm("Deselect all?")) {
            localStorage.removeItem(STORAGE_KEY);
            document.querySelectorAll('.quest-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.quest-item').forEach(div => div.classList.remove('selected'));
            document.getElementById('planning-result').style.display = 'none';
        }
    }
    function handleMapError() {
        document.getElementById('map-display').style.display = 'none';
        document.getElementById('map-controls').style.display = 'none';
        document.getElementById('map-fallback-link').style.display = 'block';
        if(panzoomInstance) panzoomInstance.pause();
    }

    // --- RENDER LOGIC WITH GROUPING ---
    function renderQuestList(quests) {
        const listContainer = document.getElementById('quest-list');
        listContainer.innerHTML = '';
        const savedSet = getSavedQuests();

        // 1. Grouping Logik
        const groups = {};
        const standalone = [];

        quests.forEach((quest, index) => {
            // Regex: Suche nach "Name - Part X"
            const match = quest.name.match(/^(.*?) - Part \d+$/);
            if (match) {
                const groupName = match[1];
                if (!groups[groupName]) groups[groupName] = [];
                groups[groupName].push({ ...quest, originalIndex: index });
            } else {
                standalone.push({ ...quest, originalIndex: index });
            }
        });

        // 2. Render Groups
        for (const [groupName, groupQuests] of Object.entries(groups)) {
            const groupId = groupName.replace(/[^a-zA-Z0-9]/g, '');
            const accordItem = document.createElement('div');
            accordItem.className = 'accordion-item';
            
            // Check if any in group is selected to maybe keep open? (Optional, kept closed for tidy view)
            
            let groupHtml = `
                <h2 class="accordion-header" id="heading-${groupId}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${groupId}">
                        üìÇ ${groupName} <span class="badge bg-dark ms-2 border border-secondary">${groupQuests.length} Parts</span>
                    </button>
                </h2>
                <div id="collapse-${groupId}" class="accordion-collapse collapse" data-bs-parent="#questAccordion">
                    <div class="accordion-body">
            `;
            
            groupQuests.forEach(q => {
                groupHtml += createQuestItemHtml(q, q.originalIndex, savedSet);
            });
            
            groupHtml += `</div></div>`;
            accordItem.innerHTML = groupHtml;
            listContainer.appendChild(accordItem);
        }

        // 3. Render Standalone
        if (standalone.length > 0) {
            const standaloneContainer = document.createElement('div');
            standalone.forEach(q => {
                standaloneContainer.innerHTML += createQuestItemHtml(q, q.originalIndex, savedSet);
            });
            listContainer.appendChild(standaloneContainer);
        }
    }

    function createQuestItemHtml(quest, index, savedSet) {
        const isChecked = savedSet.has(quest.id);
        return `
            <div class="quest-item d-flex align-items-center ${isChecked ? 'selected' : ''}" onclick="toggleSelection(${index}, this, event)">
                <input class="form-check-input quest-checkbox" 
                       type="checkbox" 
                       id="q-${index}" 
                       value="${quest.id}"
                       ${isChecked ? 'checked' : ''}
                       onchange="event.stopPropagation(); toggleSelection(${index}, this.parentElement, event)">
                <div class="ms-3 flex-grow-1">
                    <div class="d-flex align-items-center">
                        <span class="fw-bold text-light">${quest.name}</span>
                        ${quest.wikiLink ? `<a href="${quest.wikiLink}" target="_blank" class="ms-2 text-muted small" onclick="event.stopPropagation()">[Wiki]</a>` : ''}
                    </div>
                    <div class="mt-1">
                        <span class="trader-badge">üë§ ${quest.trader.name}</span>
                        <span class="text-secondary small">Lvl ${quest.minPlayerLevel}</span>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadQuests() {
        const map = document.getElementById('mapSelect').value;
        const loader = document.getElementById('loading');
        const selectionArea = document.getElementById('quest-selection-area');
        
        selectionArea.classList.add('d-none');
        document.getElementById('planning-result').style.display = 'none';
        loader.classList.remove('d-none');
        document.getElementById('error-box').classList.add('d-none');

        try {
            const response = await fetch(`${API_URL}/quests/${map}`);
            if (!response.ok) throw new Error(`Server Error: ${response.status}`);
            loadedQuests = await response.json();

            if (loadedQuests.length === 0) {
                document.getElementById('quest-list').innerHTML = '<div class="text-center text-muted p-4">No active quests found.</div>';
            } else {
                renderQuestList(loadedQuests);
            }
            selectionArea.classList.remove('d-none');
        } catch (error) {
            const err = document.getElementById('error-box');
            err.textContent = "Error: " + error.message;
            err.classList.remove('d-none');
        } finally {
            loader.classList.add('d-none');
        }
    }

    function toggleSelection(index, divElement, event) {
        const checkbox = document.getElementById(`q-${index}`);
        if (event.target !== checkbox && event.target.tagName !== 'A') {
            checkbox.checked = !checkbox.checked;
        }
        if (checkbox.checked) divElement.classList.add('selected');
        else divElement.classList.remove('selected');
        saveQuestState(loadedQuests[index].id, checkbox.checked);
    }

    function planRaid() {
        const resultBox = document.getElementById('planning-result');
        const mapName = document.getElementById('mapSelect').value;
        
        // Map Setup
        const mapDisplay = document.getElementById('map-display');
        const mapControls = document.getElementById('map-controls');
        const mapFallback = document.getElementById('map-fallback-link');
        const mapLink = document.getElementById('ext-map-link');

        mapDisplay.style.display = 'block';
        mapControls.style.display = 'flex';
        mapFallback.style.display = 'none';

        if (mapName === "Any") {
            mapDisplay.style.display = 'none';
            mapControls.style.display = 'none';
            mapFallback.style.display = 'block';
            document.getElementById('map-fallback-text').textContent = "Global Tasks.";
            mapLink.style.display = 'none';
        } else if (MAP_CONFIG[mapName]) {
            mapDisplay.src = `maps/${MAP_CONFIG[mapName].file}`;
            mapLink.href = MAP_CONFIG[mapName].url;
            mapLink.style.display = 'inline-block';
            
            if (panzoomInstance) panzoomInstance.dispose(); 
            const elem = document.getElementById('map-display');
            panzoomInstance = Panzoom(elem, { maxScale: 5, minScale: 0.5, contain: 'outside', startScale: 1 });
            elem.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
            document.getElementById('zoom-in').onclick = panzoomInstance.zoomIn;
            document.getElementById('zoom-out').onclick = panzoomInstance.zoomOut;
            document.getElementById('zoom-reset').onclick = panzoomInstance.reset;
        } else {
            handleMapError();
        }

        // Logic
        const selectedIndices = [];
        loadedQuests.forEach((_, index) => {
            const cb = document.getElementById(`q-${index}`);
            if (cb && cb.checked) selectedIndices.push(index);
        });

        if (selectedIndices.length === 0) { alert("Select a quest!"); return; }

        const neededKeys = new Map();
        const neededItems = [];
        const objectives = [];
        const unlocks = [];

        selectedIndices.forEach(index => {
            const quest = loadedQuests[index];
            
            // 1. Initial Rewards sammeln (f√ºr den Vergleich)
            const providedItemIds = new Set();
            if (quest.startRewards && quest.startRewards.items) {
                quest.startRewards.items.forEach(r => {
                    if(r.item) providedItemIds.add(r.item.id);
                });
            }

            // 2. Keys
            if (quest.neededKeys) {
                quest.neededKeys.forEach(g => {
                    if(g.keys && g.keys.length > 0) neededKeys.set(g.keys[0].name, g.keys[0]);
                });
            }

            // 3. Objectives & Items processing
            if (quest.objectives) {
                quest.objectives.forEach(obj => {
                    objectives.push({ quest: quest.name, desc: obj.description });
                    
                    let item = null;
                    let count = 0;

                    // Typ 1: Item abgeben
                    if (obj.type === 'GiveItem' && obj.item) {
                        item = obj.item;
                        count = obj.count;
                    }
                    // Typ 2: Marker platzieren (NEU!)
                    else if (obj.type === 'Mark' && obj.markerItem) {
                        item = obj.markerItem;
                        count = obj.count;
                    }

                    if (item) {
                        // VETERAN CHECK: Krieg ich das Item geschenkt oder muss ich es besorgen?
                        const isProvided = providedItemIds.has(item.id);
                        neededItems.push({
                            name: item.name,
                            count: count,
                            icon: item.iconLink,
                            status: isProvided ? 'provided' : 'acquire'
                        });
                    }
                });
            }

            // 4. Unlocks
            if (quest.derived_unlocks) {
                quest.derived_unlocks.forEach(u => unlocks.push({ from: quest.name, nextName: u.name, nextMap: u.map, trader: u.trader }));
            }
        });

        // Rendering Results
        document.getElementById('required-keys').innerHTML = neededKeys.size > 0 
            ? Array.from(neededKeys.values()).map(k => `
                <div class="item-badge" title="${k.name}">
                    ${k.iconLink ? `<img src="${k.iconLink}" class="key-icon">` : 'üîë'}
                    <span>${k.shortName || k.name}</span>
                </div>`).join('') 
            : '<span class="text-success p-2">No special keys required.</span>';

        document.getElementById('required-items').innerHTML = neededItems.length > 0 
            ? neededItems.map(i => `
                <div class="item-badge ${i.status}">
                    ${i.icon ? `<img src="${i.icon}" class="key-icon">` : 'üì¶'}
                    <span>${i.count}x ${i.name}</span>
                    <span class="ms-2 badge bg-dark bg-opacity-50" style="font-size:0.7em">
                        ${i.status === 'provided' ? 'üéÅ Provided' : 'üîç Acquire'}
                    </span>
                </div>`).join('') 
            : '<span class="text-muted p-2">-</span>';

        document.getElementById('mission-steps').innerHTML = objectives.map(obj => `
            <li class="list-group-item bg-transparent text-light border-secondary">
                <span class="text-warning fw-bold">${obj.quest}:</span> ${obj.desc}
            </li>`).join('');

        const progressContainer = document.getElementById('progression-list');
        progressContainer.innerHTML = unlocks.length > 0 
            ? unlocks.map(u => `
                <div class="mb-2 p-2 border border-secondary rounded bg-dark bg-opacity-50">
                    <div class="text-muted" style="font-size: 0.85em;">Completing <em class="text-light">${u.from}</em> unlocks:</div>
                    <div class="fw-bold" style="color: #a29bfe;">‚û• ${u.nextName}</div>
                    <div class="d-flex justify-content-between mt-1 small text-secondary"><span>üó∫Ô∏è ${u.nextMap}</span><span>üë§ ${u.trader}</span></div>
                </div>`).join('')
            : '<div class="text-muted p-2 fst-italic">No direct follow-up quests.</div>';

        resultBox.style.display = 'block';
        resultBox.scrollIntoView({ behavior: 'smooth' });
    }
</script>
</body>
</html>