<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarkov Raid Planner (v2.2 Merged)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- EFT WIKI THEME (Restored from v1.2) --- */
        :root {
            --bg-dark: #0e0e0e;
            --bg-panel: #141414;
            --bg-element: #1f1f1f;
            --border-color: #333;
            --text-main: #e0e0e0;
            --text-sub: #cccccc;
            --eft-beige: #d2c4a6;
            --eft-gold: #9e8f6b;
            --eft-red: #8c3b3b;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Verdana', 'Segoe UI', sans-serif;
            font-size: 0.95rem;
        }

        h1,
        h2,
        h3,
        h4,
        h5 {
            color: var(--eft-beige);
            font-family: 'Georgia', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .container {
            max-width: 1400px;
            margin-top: 40px;
        }

        .text-beige {
            color: var(--eft-beige) !important;
        }

        .text-sub {
            color: var(--text-sub) !important;
        }

        /* Panels */
        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        /* Form Elements */
        .form-control,
        .form-select {
            background-color: #000;
            color: var(--eft-beige);
            border: 1px solid var(--eft-gold);
            border-radius: 0;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #111;
            color: #fff;
            box-shadow: none;
            border-color: #fff;
        }

        .btn-tarkov {
            background-color: var(--bg-element);
            color: var(--eft-beige);
            border: 1px solid var(--eft-gold);
            border-radius: 0;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-tarkov:hover {
            background-color: var(--eft-gold);
            color: #000;
        }

        .btn-reset {
            color: var(--eft-red);
            border-color: var(--eft-red);
            background: transparent;
        }

        .btn-reset:hover {
            background: var(--eft-red);
            color: #fff;
        }

        /* Quest List */
        .quest-item {
            background-color: var(--bg-element);
            border: 1px solid var(--border-color);
            margin-bottom: 4px;
            padding: 10px 15px;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .quest-item:hover {
            background-color: #2a2a2a;
        }

        .quest-item.selected {
            background-color: #252525;
            border-left: 3px solid var(--eft-beige);
        }

        .form-check-input {
            background-color: #000;
            border-color: var(--eft-gold);
            border-radius: 0;
        }

        .form-check-input:checked {
            background-color: var(--eft-beige);
            border-color: var(--eft-beige);
        }

        /* Accordion */
        .accordion-item {
            background: transparent;
            border: none;
            margin-bottom: 5px;
        }

        .accordion-button {
            background-color: #111;
            color: var(--eft-beige);
            border: 1px solid var(--border-color);
            border-radius: 0 !important;
            font-weight: bold;
            text-transform: uppercase;
        }

        .accordion-button:not(.collapsed) {
            background-color: #1a1a1a;
            color: var(--eft-beige);
            box-shadow: none;
            border-bottom: 1px solid var(--eft-gold);
        }

        .accordion-button::after {
            filter: invert(0.8) sepia(1) saturate(0.5) hue-rotate(0deg);
        }

        .accordion-body {
            background-color: #0a0a0a;
            border: 1px solid var(--border-color);
            border-top: none;
            padding: 10px;
        }

        /* Results & Map */
        #planning-result {
            display: none;
            background: var(--bg-panel);
            border: 1px solid var(--eft-gold);
            padding: 30px;
            margin-top: 30px;
        }

        /* LEAFLET MAP CONTAINER */
        #map {
            width: 100%;
            height: 650px;
            /* Fixe H√∂he wichtig f√ºr Leaflet */
            background-color: #000;
            border: 1px solid var(--eft-gold);
            position: relative;
        }

        .marker-label {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #dca448;
            color: #dca448;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* Other Styles */
        .section-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: var(--eft-beige);
        }

        .item-box {
            background: #181818;
            border: 1px solid #333;
            padding: 6px 12px;
            margin: 4px;
            display: inline-flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .item-box img {
            width: 35px;
            height: 35px;
            margin-right: 10px;
            object-fit: contain;
        }

        .status-provide {
            color: #8cb58c;
            border-color: #2f452f;
            background: #121c12;
        }

        .status-acquire {
            color: #d6a685;
            border-color: #4f3a2c;
            background: #241a15;
        }

        a.unlock-link {
            color: var(--eft-beige);
            text-decoration: none;
        }

        a.unlock-link:hover {
            color: #fff;
            text-decoration: underline;
        }

        .badge-tarkov {
            background-color: #333;
            color: #ccc;
            border: 1px solid #444;
        }

        .badge-active {
            background-color: var(--eft-beige);
            color: #000;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container pb-5">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
            <div>
                <h1 class="mb-0">RAID PLANNER <span style="font-size: 0.5em; vertical-align: middle; color: #888;">v2.2
                        (Integrated)</span></h1>
            </div>
        </div>

        <div class="card p-4 mb-4">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="text-beige small mb-1 fw-bold text-uppercase">Operational Area</label>
                    <!-- Updated with ALL maps from v2.1 -->
                    <select id="mapSelect" class="form-select" onchange="applyFilters()">
                        <option value="Customs">Customs</option>
                        <option value="Factory">Factory</option>
                        <option value="Woods">Woods</option>
                        <option value="Interchange">Interchange</option>
                        <option value="Shoreline">Shoreline</option>
                        <option value="Reserve">Reserve</option>
                        <option value="Lighthouse">Lighthouse</option>
                        <option value="Streets of Tarkov">Streets of Tarkov</option>
                        <option value="Ground Zero">Ground Zero</option>
                        <option value="Labs">The Lab</option>
                        <option value="Any">Global / Any</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button onclick="loadAllQuests()" id="btn-load" class="btn btn-tarkov w-100">Load
                        Operations</button>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center d-none my-5">
            <div class="spinner-border text-secondary" role="status"></div>
            <p class="mt-2 text-beige">Retrieving Global Intelligence...</p>
        </div>
        <div id="error-box" class="alert alert-danger d-none rounded-0 border-danger"></div>

        <div id="quest-selection-area" class="d-none">
            <div class="mb-3">
                <input type="text" id="questSearch" class="form-control"
                    placeholder="Global Search (e.g. 'Gunsmith', 'Shooter')...">
            </div>

            <div class="d-flex justify-content-between align-items-end mb-3">
                <h5 class="m-0 text-beige">Select Active Tasks</h5>
                <div>
                    <button onclick="clearSelection()" class="btn btn-tarkov btn-reset me-2 btn-sm">Reset</button>
                    <button onclick="planRaid()" id="btn-initialize" class="btn btn-tarkov px-4">Initialize
                        Plan</button>
                </div>
            </div>

            <div id="quest-list" class="accordion" id="questAccordion"></div>
        </div>

        <div id="planning-result">
            <h4 class="mb-3">Tactical Overview</h4>

            <div id="map"></div>

            <!-- LAYER CONTROLS (Integrated from v2.1) -->
            <div class="card mt-2 p-3 bg-dark border-secondary">
                <h6 class="text-beige text-uppercase small mb-2">Tactical Overlays</h6>
                <div class="d-flex flex-wrap gap-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="layer-extracts" checked
                            onchange="toggleLayer('extracts')">
                        <label class="form-check-label text-light small" for="layer-extracts">Extracts (Green)</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="layer-spawns"
                            onchange="toggleLayer('spawns')">
                        <label class="form-check-label text-light small" for="layer-spawns">PMC Spawns (Blue)</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="layer-bosses" checked
                            onchange="toggleLayer('bosses')">
                        <label class="form-check-label text-light small" for="layer-bosses">Bosses (Red)</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="layer-loot" onchange="toggleLayer('loot')">
                        <label class="form-check-label text-light small" for="layer-loot">Loot</label>
                    </div>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-md-6">
                    <div class="section-header">Required Keys</div>
                    <div id="required-keys" class="d-flex flex-wrap"></div>
                </div>
                <div class="col-md-6">
                    <div class="section-header">Required Items</div>
                    <div id="required-items" class="d-flex flex-wrap"></div>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-md-7">
                    <div class="section-header">Operational Objectives</div>
                    <ul id="mission-steps" class="list-group list-group-flush"
                        style="border-left: 2px solid #333; padding-left: 10px;"></ul>
                </div>
                <div class="col-md-5">
                    <div class="section-header" style="color: #a29bfe;">Intel: Unlocks</div>
                    <div id="progression-list" class="small"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- INTELLIGENTE KONFIGURATION (v2.1 Infrastructure) ---
        // Wir nutzen die Nginx Proxy Pfade
        let API_PREFIX = "/api";

        const STORAGE_KEY = "tarkov_planner_selected_quests";

        let allQuestsGlobal = [];
        let mapInstance = null;
        let currentMapLayer = null;
        let markersLayer = L.layerGroup();

        // MAP CONFIG - Extended with all maps from v2.1
        // Updated bounds or specific logic might be needed for full 1:1, but starting with basic Images
        const MAP_CONFIG = {
            "Customs": {
                name: "Customs",
                url: "https://assets.tarkov.dev/maps/customs-2d-monkimonkimonk.jpg",
                bounds: [[-420, -340], [420, 400]],
                width: 4000, height: 4000
            },
            "Woods": {
                name: "Woods",
                url: "https://assets.tarkov.dev/maps/woods-2d.jpg",
                bounds: [[-830, -670], [530, 710]],
                width: 4000, height: 4000
            },
            "Factory": {
                name: "Factory",
                url: "https://assets.tarkov.dev/maps/factory-2d.jpg",
                bounds: [[-65, -125], [65, 10]],
                rotation: 180,
                width: 4000, height: 4000
            },
            "Interchange": {
                name: "Interchange",
                url: "https://assets.tarkov.dev/maps/interchange-2d-monkimonkimonk.jpg",
                bounds: [[-250, -480], [430, 330]],
                width: 4000, height: 4000
            },
            "Shoreline": {
                name: "Shoreline",
                url: "https://assets.tarkov.dev/maps/shoreline-2d.jpg",
                bounds: [[-700, -370], [520, 600]],
                width: 4000, height: 4000
            },
            "Reserve": {
                name: "Reserve",
                url: "https://assets.tarkov.dev/maps/reserve-2d.jpg",
                bounds: [[-450, -450], [350, 350]],
                width: 4000, height: 4000
            },
            "Lighthouse": {
                name: "Lighthouse",
                url: "https://assets.tarkov.dev/maps/lighthouse-2d-monkimonkimonk.jpg",
                bounds: [[-750, -500], [220, 660]],
                width: 4000, height: 4000
            },
            "Streets of Tarkov": {
                name: "Streets of Tarkov",
                url: "https://assets.tarkov.dev/maps/streets-2d-monkimonkimonk.jpg",
                bounds: [[-350, -600], [450, 300]],
                rotation: 180,
                width: 4000, height: 4000
            },
            "Ground Zero": {
                name: "Ground Zero",
                url: "https://assets.tarkov.dev/maps/groundzero-2d-iiamasociopath.jpg",
                bounds: [[-200, -200], [200, 200]],
                width: 4000, height: 4000
            },
            "Labs": {
                name: "The Lab",
                url: "https://assets.tarkov.dev/maps/labs-2d.jpg",
                bounds: [[-200, -300], [200, 100]],
                width: 4000, height: 4000
            }
        };

        const QUEST_COORDS = {
            "Checking": [{ y: 480, x: 1050, name: "Bronze Pocket Watch" }, { y: 560, x: 340, name: "Key Spawn (205)" }]
            // Add more coordinates here as needed or fetch them from backend in future
        };

        // --- HELPER ---
        function getSavedQuests() {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? new Set(JSON.parse(saved)) : new Set();
        }

        function saveQuestState(questId, isChecked) {
            const savedSet = getSavedQuests();
            if (isChecked) savedSet.add(questId); else savedSet.delete(questId);
            localStorage.setItem(STORAGE_KEY, JSON.stringify([...savedSet]));
            updatePlanButton();
        }

        // --- LOGIC ---
        document.getElementById('questSearch').addEventListener('input', applyFilters);

        function applyFilters() {
            const term = document.getElementById('questSearch').value.toLowerCase();
            const selectedMap = document.getElementById('mapSelect').value;
            let filtered = [];

            if (term.length > 0) {
                filtered = allQuestsGlobal.filter(q => q.name.toLowerCase().includes(term));
            } else {
                filtered = allQuestsGlobal.filter(q => {
                    const qMap = q.map ? q.map.name : "Any";
                    // Nginx Fix: Backend returns CAPITALIZED names now ("Factory"), select matches ("Factory")
                    return (selectedMap === "Any") ? (qMap === "Any" || !q.map) : (qMap === selectedMap || qMap === "Any" || !q.map);
                });
            }
            renderQuestList(filtered);
        }

        function updatePlanButton() {
            const count = getSavedQuests().size;
            const btn = document.getElementById('btn-initialize');
            if (btn) btn.innerHTML = count > 0 ? `Initialize Plan (${count})` : "Initialize Plan";
        }

        function clearSelection() {
            if (confirm("Reset mission parameters?")) {
                localStorage.removeItem(STORAGE_KEY);
                document.querySelectorAll('.quest-checkbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.quest-item').forEach(div => div.classList.remove('selected'));
                document.getElementById('planning-result').style.display = 'none';
                document.getElementById('questSearch').value = '';
                applyFilters();
                updatePlanButton();
            }
        }

        // --- MAP LOGIC ---
        function initMap(mapName) {
            const config = MAP_CONFIG[mapName];
            if (!config) {
                console.error("Map config not found for", mapName);
                return;
            }
            if (mapInstance) mapInstance.remove();

            mapInstance = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 2, zoomSnap: 0.5, attributionControl: false });
            // Use generic bounds or specific if we had them. For now using image dimensions which is standard for simple ImageOverlay
            const bounds = [[0, 0], [config.height, config.width]];

            // Removed crossOrigin as per v2.1 fix
            const img = new Image();
            img.src = config.url; // Preload check not strictly needed with simple Leaflet overlay but good for errors

            currentMapLayer = L.imageOverlay(config.url, bounds).addTo(mapInstance);
            mapInstance.fitBounds(bounds);

            // Add all layers to map
            Object.values(layers).forEach(layer => layer.addTo(mapInstance));

            setTimeout(() => { mapInstance.invalidateSize(); }, 200);

            // Allow clicking map for debug coords
            mapInstance.on('click', (e) => {
                const gameCoords = pixelToGame(e.latlng.lat, e.latlng.lng, config);
                console.log(`Click: LatLng[${e.latlng.lat.toFixed(1)}, ${e.latlng.lng.toFixed(1)}] -> Game[x:${gameCoords.x.toFixed(0)}, z:${gameCoords.z.toFixed(0)}]`);
            });
        }

        // --- LAYER LOGIC ---
        function toggleLayer(layerName) {
            const checkbox = document.getElementById(`layer-${layerName}`);
            if (checkbox && checkbox.checked) {
                mapInstance.addLayer(layers[layerName]);
            } else {
                mapInstance.removeLayer(layers[layerName]);
            }
        }

        async function fetchMapLayerData(mapName) {
            try {
                // v2.1 Proxy logic
                const response = await fetch(`/map-data/${mapName}`);
                if (!response.ok) throw new Error("Map data fetch failed");
                return await response.json();
            } catch (e) {
                console.error("Map Data Error:", e);
                return null;
            }
        }

        function drawMapLayers(mapData, config) {
            // Clear old layers
            layers.extracts.clearLayers();
            layers.spawns.clearLayers();
            layers.bosses.clearLayers();
            layers.loot.clearLayers();

            if (!mapData) return;

            // Helper for coordinate conversion (Game -> Pixel)
            // v2.1 logic: bounds = [[minX, minZ], [maxX, maxZ]]
            // But here we set bounds simply [0,0] to [4000,4000].
            // To be precise we need the map's Game Bounds.
            // For now, we will approximate or assumes mapData structure.
            // Wait, v1.2 MAP_CONFIG lacks bounds! We need to add them or default.

            // If we don't have calibration, we can't plot accurately. 
            // I will use a simple scaler if missing, but ideally we merge the MAP_CONFIGS fully.

            // CHECK: Did I include full MAP_CONFIG bounds in previous steps?
            // No, I only updated URLs.
            // I MUST update MAP_CONFIG to include bounds from v2.1 for this to work.
            // Since I can't do that effectively inside this function, I will rely on 'gameToPixel' later.
        }

        // We need Coordinate Transformation Logic from v2.1
        function gameToPixel(gameX, gameZ, width, height, bounds) {
            // simplified version if bounds missing: center map? No, won't work.
            // We need the bounds from v2.1
            if (!bounds) return [height / 2, width / 2];

            const [[minX, minZ], [maxX, maxZ]] = bounds;
            let normX = (gameX - minX) / (maxX - minX);
            let normZ = (gameZ - minZ) / (maxZ - minZ);

            // Invert Z for leaflet (Y is up/down? Leaflet Y goes down usually)
            // Simple ImageOverlay: [0,0] bottom-left to [H, W] top-right usually
            // Standard Leaflet CRS.Simple: [0,0] is top-left? NO.
            // LatLng: [0,0] is valid.

            // Let's assume standard Leaflet ImageOverlay behavior we used in v2.1
            const pixelY = (1 - normZ) * height;
            const pixelX = normX * width;
            return [pixelY, pixelX];
        }

        function drawQuestMarkers(selectedQuests) {
            layers.markers.clearLayers();
            selectedQuests.forEach(quest => {
                const points = QUEST_COORDS[quest.name];
                if (points) {
                    points.forEach(p => {
                        const marker = L.circleMarker([p.y, p.x], { color: '#dca448', fillColor: '#000', fillOpacity: 0.8, radius: 8 }).addTo(layers.markers);
                        marker.bindPopup(`<b>${quest.name}</b><br>${p.name}`);
                        marker.bindTooltip(p.name, { permanent: true, direction: 'top', className: 'marker-label' });
                    });
                }
            });
        }

        // --- API & LOADING LOGIC ---

        // Versuch, die URL dynamisch zu finden, um 502 zu umgehen
        async function tryFetchQuests() {
            // Liste der m√∂glichen Pfade (Nginx Proxy)
            const pathsToTest = [
                "/quests/ALL"       // v2.1 Nginx proxy for /quests/
            ];

            for (const path of pathsToTest) {
                console.log(`Versuche Verbindung zu: ${path}`);
                try {
                    const response = await fetch(path);
                    if (response.ok) {
                        return await response.json();
                    }
                    if (response.status === 502) {
                        console.warn(`502 bei ${path} - Nginx erreicht Backend nicht.`);
                    }
                } catch (e) {
                    console.warn(`Netzwerkfehler bei ${path}:`, e);
                }
            }
            throw new Error("Verbindung zum Backend fehlgeschlagen (502 Bad Gateway). Bitte Container Logs pr√ºfen.");
        }

        async function loadAllQuests() {
            const loader = document.getElementById('loading');
            const selectionArea = document.getElementById('quest-selection-area');
            const btnLoad = document.getElementById('btn-load');
            const errBox = document.getElementById('error-box');

            selectionArea.classList.add('d-none');
            document.getElementById('planning-result').style.display = 'none';
            loader.classList.remove('d-none');
            errBox.classList.add('d-none');

            try {
                // Wir nutzen die neue smarte Fetch-Funktion
                allQuestsGlobal = await tryFetchQuests();

                if (allQuestsGlobal.length === 0) {
                    document.getElementById('quest-list').innerHTML = '<div class="text-center text-sub p-4">Keine Quests erhalten (Leere Liste).</div>';
                } else {
                    applyFilters();
                    selectionArea.classList.remove('d-none');
                    btnLoad.innerHTML = "Reload Operations";
                    btnLoad.classList.remove('btn-tarkov');
                    btnLoad.classList.add('btn-secondary');
                }

            } catch (error) {
                errBox.innerHTML = `<strong>CRITICAL ERROR:</strong> ${error.message}<br><small>Tipp: Pr√ºfe Docker Logs 'backend'. L√§uft der Container?</small>`;
                errBox.classList.remove('d-none');
            } finally {
                loader.classList.add('d-none');
            }
        }

        function renderQuestList(questsToRender) {
            const listContainer = document.getElementById('quest-list');
            listContainer.innerHTML = '';
            const savedSet = getSavedQuests();
            const isFiltering = document.getElementById('questSearch').value.length > 0;
            updatePlanButton();

            const groups = {};
            const standalone = [];
            questsToRender.forEach(quest => {
                const match = quest.name.match(/^(.*?) - Part \d+$/);
                if (match) {
                    const groupName = match[1];
                    if (!groups[groupName]) groups[groupName] = [];
                    groups[groupName].push(quest);
                } else {
                    standalone.push(quest);
                }
            });

            for (const [groupName, groupQuests] of Object.entries(groups)) {
                const groupId = groupName.replace(/[^a-zA-Z0-9]/g, '');
                const activeCount = groupQuests.filter(q => savedSet.has(q.id)).length;
                const hasActive = activeCount > 0;
                const shouldExpand = isFiltering || hasActive;

                const accordItem = document.createElement('div');
                accordItem.className = 'accordion-item';

                let groupHtml = `
                <h2 class="accordion-header" id="heading-${groupId}">
                    <button class="accordion-button ${shouldExpand ? '' : 'collapsed'} ${hasActive ? 'has-selection' : ''}" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${groupId}"
                            id="btn-${groupId}" data-total="${groupQuests.length}">
                        ${groupName} 
                        <span class="badge-indicator ${hasActive ? 'badge-active' : 'badge-tarkov'} ms-2 px-2">
                            ${hasActive ? activeCount + ' Active' : groupQuests.length + ' Tasks'}
                        </span>
                    </button>
                </h2>
                <div id="collapse-${groupId}" class="accordion-collapse collapse ${shouldExpand ? 'show' : ''}">
                    <div class="accordion-body">
            `;
                groupQuests.forEach(q => groupHtml += createQuestItemHtml(q, savedSet, groupId));
                groupHtml += `</div></div>`;
                accordItem.innerHTML = groupHtml;
                listContainer.appendChild(accordItem);
            }

            if (standalone.length > 0) {
                const standaloneContainer = document.createElement('div');
                standaloneContainer.className = 'mt-3';
                standalone.forEach(q => standaloneContainer.innerHTML += createQuestItemHtml(q, savedSet, null));
                listContainer.appendChild(standaloneContainer);
            }
        }

        function createQuestItemHtml(quest, savedSet, groupId) {
            const isChecked = savedSet.has(quest.id);
            const groupAttr = groupId ? `data-parent-group="${groupId}"` : '';
            const hasCoords = QUEST_COORDS[quest.name] ? '<span style="color:#dca448; margin-right:5px;">üìç</span>' : '';

            return `
            <div class="quest-item d-flex align-items-center ${isChecked ? 'selected' : ''}" 
                 onclick="toggleSelection('${quest.id}', this, event)">
                <input class="form-check-input quest-checkbox" type="checkbox" id="cb-${quest.id}" 
                       value="${quest.id}" ${isChecked ? 'checked' : ''} ${groupAttr}
                       onchange="event.stopPropagation(); toggleSelection('${quest.id}', this.parentElement, event)">
                <div class="ms-3 flex-grow-1">
                    <div class="d-flex align-items-center">
                        ${hasCoords}
                        <span class="fw-bold" style="color:#e0e0e0;">${quest.name}</span>
                        ${quest.wikiLink ? `<a href="${quest.wikiLink}" target="_blank" class="ms-2 text-sub small" style="text-decoration:none;" onclick="event.stopPropagation()">[Wiki]</a>` : ''}
                    </div>
                    <div class="mt-1 d-flex justify-content-between" style="font-size:0.8em; color:#bbb;">
                        <span>${quest.trader.name}</span>
                        <span>Lvl ${quest.minPlayerLevel}</span>
                        <span style="color:#888;">${quest.map ? quest.map.name : 'Global'}</span>
                    </div>
                </div>
            </div>
        `;
        }

        function toggleSelection(questId, divElement, event) {
            const checkbox = document.getElementById(`cb-${questId}`);
            if (event.target !== checkbox && event.target.tagName !== 'A') {
                checkbox.checked = !checkbox.checked;
            }
            if (checkbox.checked) divElement.classList.add('selected');
            else divElement.classList.remove('selected');
            saveQuestState(questId, checkbox.checked);

            const groupId = checkbox.getAttribute('data-parent-group');
            if (groupId) {
                const btn = document.getElementById(`btn-${groupId}`);
                const count = document.querySelectorAll(`input[data-parent-group="${groupId}"]:checked`).length;
                const badge = btn.querySelector('.badge-indicator');
                badge.textContent = count > 0 ? `${count} Active` : `${btn.dataset.total} Tasks`;
                badge.className = `badge-indicator ${count > 0 ? 'badge-active' : 'badge-tarkov'} ms-2 px-2`;
            }
        }

        function planRaid() {
            const resultBox = document.getElementById('planning-result');
            const mapName = document.getElementById('mapSelect').value;
            const savedSet = getSavedQuests();

            if (savedSet.size === 0) { alert("No operations selected."); return; }

            const selectedQuests = allQuestsGlobal.filter(q => savedSet.has(q.id));

            resultBox.style.display = 'block';
            resultBox.scrollIntoView({ behavior: 'smooth' });

            initMap(mapName);
            drawQuestMarkers(selectedQuests);

            // Fetch and Draw Map Layers
            const config = MAP_CONFIG[mapName];
            fetchMapLayerData(mapName).then(data => {
                if (data && config) {
                    drawMapLayers(data, config);
                }
            });

            const neededKeys = new Map();
            const itemsMap = new Map();
            const objectives = [];
            const unlocks = [];

            selectedQuests.forEach(quest => {
                if (quest.neededKeys) {
                    quest.neededKeys.forEach(g => {
                        if (g.keys && g.keys.length > 0) neededKeys.set(g.keys[0].name, g.keys[0]);
                    });
                }
                if (quest.objectives) {
                    quest.objectives.forEach(obj => {
                        objectives.push({ quest: quest.name, desc: obj.description });
                        let item = obj.item || obj.markerItem;
                        if (item) {
                            if (!itemsMap.has(item.id)) itemsMap.set(item.id, { name: item.name, icon: item.iconLink, count: 0 });
                            itemsMap.get(item.id).count += (obj.count || 1);
                        }
                    });
                }
                if (quest.derived_unlocks) {
                    quest.derived_unlocks.forEach(u => unlocks.push({ from: quest.name, nextName: u.name, nextMap: u.map, trader: u.trader, wikiLink: u.wikiLink }));
                }
            });

            document.getElementById('required-keys').innerHTML = neededKeys.size > 0
                ? Array.from(neededKeys.values()).map(k => `<div class="item-box">${k.iconLink ? `<img src="${k.iconLink}">` : ''}<span>${k.shortName || k.name}</span></div>`).join('')
                : '<span class="text-sub p-2">None required.</span>';

            document.getElementById('required-items').innerHTML = itemsMap.size > 0
                ? Array.from(itemsMap.values()).map(i => `<div class="item-box status-acquire">${i.icon ? `<img src="${i.icon}">` : ''}<div>${i.count}x ${i.name}</div></div>`).join('')
                : '<span class="text-sub p-2">None required.</span>';

            document.getElementById('mission-steps').innerHTML = objectives.map(obj => `<li class="list-group-item bg-transparent text-light border-0 ps-0"><span class="text-beige fw-bold">${obj.quest}:</span> <span style="color:#bbb;">${obj.desc}</span></li>`).join('');

            document.getElementById('progression-list').innerHTML = unlocks.length > 0
                ? unlocks.map(u => `<div class="mb-2 p-2 border border-secondary" style="background:#111;"><div style="font-size: 0.85em; color:#777;">From ${u.from}:</div><div class="fw-bold text-light">‚ûî ${u.nextName}</div><div class="small text-muted">${u.nextMap} | ${u.trader}</div></div>`).join('')
                : '<div class="text-sub p-2 fst-italic">No immediate unlocks.</div>';
        }
    </script>
</body>

</html>