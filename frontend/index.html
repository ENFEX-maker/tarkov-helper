<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarkov Raid Planner - Leaflet PoC v2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- EFT WIKI THEME --- */
        :root {
            --bg-dark: #0e0e0e;       
            --bg-panel: #141414;      
            --bg-element: #1f1f1f;    
            --border-color: #333;
            --text-main: #e0e0e0;
            --text-sub: #cccccc;      
            --eft-beige: #d2c4a6;     
            --eft-gold: #9e8f6b;      
            --eft-red: #8c3b3b;
            --eft-green: #5a8c5a;
            --eft-blue: #5a7a9e;
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Verdana', 'Segoe UI', sans-serif; 
            font-size: 0.95rem;
        }

        h1, h2, h3, h4, h5 {
            color: var(--eft-beige);
            font-family: 'Georgia', serif; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .container { max-width: 1400px; margin-top: 40px; }
        .text-beige { color: var(--eft-beige) !important; }
        .text-sub { color: var(--text-sub) !important; }

        /* Panels */
        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        /* Form Elements */
        .form-control, .form-select {
            background-color: #000;
            color: var(--eft-beige);
            border: 1px solid var(--eft-gold);
            border-radius: 0;
        }
        .form-control:focus, .form-select:focus { 
            background-color: #111;
            color: #fff;
            box-shadow: none; 
            border-color: #fff; 
        }

        .btn-tarkov {
            background-color: var(--bg-element);
            color: var(--eft-beige);
            border: 1px solid var(--eft-gold);
            border-radius: 0;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-tarkov:hover { background-color: var(--eft-gold); color: #000; }
        
        .btn-reset { color: var(--eft-red); border-color: var(--eft-red); background: transparent; }
        .btn-reset:hover { background: var(--eft-red); color: #fff; }

        /* Quest List */
        .quest-item {
            background-color: var(--bg-element);
            border: 1px solid var(--border-color);
            margin-bottom: 4px;
            padding: 10px 15px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s;
        }
        .quest-item:hover { background-color: #2a2a2a; }
        .quest-item.selected {
            background-color: #252525;
            border-left: 3px solid var(--eft-beige);
        }
        
        .form-check-input {
            background-color: #000;
            border-color: var(--eft-gold);
            border-radius: 0;
        }
        .form-check-input:checked {
            background-color: var(--eft-beige);
            border-color: var(--eft-beige);
        }

        /* Accordion */
        .accordion-item { background: transparent; border: none; margin-bottom: 5px; }
        .accordion-button {
            background-color: #111;
            color: var(--eft-beige);
            border: 1px solid var(--border-color);
            border-radius: 0 !important;
            font-weight: bold;
            text-transform: uppercase;
        }
        .accordion-button:not(.collapsed) {
            background-color: #1a1a1a;
            color: var(--eft-beige);
            box-shadow: none;
            border-bottom: 1px solid var(--eft-gold);
        }
        .accordion-button::after { filter: invert(0.8) sepia(1) saturate(0.5) hue-rotate(0deg); }
        .accordion-body { 
            background-color: #0a0a0a; 
            border: 1px solid var(--border-color); 
            border-top: none; 
            padding: 10px; 
        }

        /* Results & Map */
        #planning-result {
            display: none;
            background: var(--bg-panel);
            border: 1px solid var(--eft-gold);
            padding: 30px;
            margin-top: 30px;
        }

        /* ========== LEAFLET MAP CONTAINER ========== */
        #map {
            width: 100%; 
            height: 700px;
            background-color: #0a0a0a;
            border: 2px solid var(--eft-gold);
            position: relative;
        }
        
        /* Map Loading/Error States */
        .map-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
            color: var(--eft-beige);
        }
        .map-status.error {
            color: var(--eft-red);
        }
        
        /* Custom Marker Labels */
        .marker-label {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--eft-gold);
            color: var(--eft-gold);
            padding: 3px 8px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .marker-label-quest {
            border-color: var(--eft-beige);
            color: var(--eft-beige);
        }
        
        .marker-label-extract {
            border-color: var(--eft-green);
            color: var(--eft-green);
        }
        
        .marker-label-loot {
            border-color: var(--eft-blue);
            color: var(--eft-blue);
        }

        /* Custom Popup Styling */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid var(--eft-gold);
            border-radius: 0;
            color: var(--text-main);
        }
        .leaflet-popup-tip {
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid var(--eft-gold);
        }
        .leaflet-popup-content {
            margin: 12px 15px;
            font-size: 13px;
        }
        .popup-title {
            color: var(--eft-beige);
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 6px;
        }
        .popup-quest-name {
            color: var(--eft-gold);
            font-size: 11px;
            margin-bottom: 5px;
        }
        .popup-desc {
            color: #bbb;
            font-size: 12px;
            line-height: 1.4;
        }
        .popup-screenshot {
            width: 100%;
            max-width: 280px;
            margin-top: 10px;
            border: 1px solid var(--border-color);
        }
        .popup-hint {
            background: #1a1a1a;
            padding: 8px;
            margin-top: 8px;
            font-size: 11px;
            color: #999;
            border-left: 2px solid var(--eft-gold);
        }

        /* Layer Control Styling */
        .leaflet-control-layers {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid var(--eft-gold);
            border-radius: 0;
            color: var(--text-main);
        }
        .leaflet-control-layers-expanded {
            padding: 10px 15px;
        }
        .leaflet-control-layers label {
            color: var(--text-main);
        }
        .leaflet-control-layers-selector {
            margin-right: 8px;
        }

        /* Zoom Control */
        .leaflet-control-zoom a {
            background: var(--bg-element);
            color: var(--eft-beige);
            border: 1px solid var(--eft-gold);
            border-radius: 0;
        }
        .leaflet-control-zoom a:hover {
            background: var(--eft-gold);
            color: #000;
        }

        /* Coordinates Display */
        #coords-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            color: var(--eft-gold);
            padding: 5px 12px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        /* Other Styles */
        .section-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: var(--eft-beige);
        }

        .item-box {
            background: #181818;
            border: 1px solid #333;
            padding: 6px 12px;
            margin: 4px;
            display: inline-flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .item-box img { width: 35px; height: 35px; margin-right: 10px; object-fit: contain; }
        
        .status-provide { color: #8cb58c; border-color: #2f452f; background: #121c12; }
        .status-acquire { color: #d6a685; border-color: #4f3a2c; background: #241a15; }
        
        a.unlock-link { color: var(--eft-beige); text-decoration: none; }
        a.unlock-link:hover { color: #fff; text-decoration: underline; }
        .badge-tarkov { background-color: #333; color: #ccc; border: 1px solid #444; }
        .badge-active { background-color: var(--eft-beige); color: #000; font-weight: bold; }

        /* Layer Legend */
        .layer-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #0a0a0a;
            border: 1px solid var(--border-color);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            text-transform: uppercase;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
        }
        .legend-quest { background: var(--eft-beige); border-color: var(--eft-beige); }
        .legend-extract { background: var(--eft-green); border-color: var(--eft-green); }
        .legend-loot { background: var(--eft-blue); border-color: var(--eft-blue); }

        /* Unlock Links */
        .unlock-item {
            margin-bottom: 8px;
            padding: 10px 12px;
            border: 1px solid #333;
            background: #111;
            transition: all 0.15s;
        }
        .unlock-item:hover {
            border-color: var(--eft-gold);
            background: #1a1a1a;
        }
        .unlock-item a {
            color: var(--eft-beige);
            text-decoration: none;
            font-weight: bold;
        }
        .unlock-item a:hover {
            color: #fff;
            text-decoration: underline;
        }
        .unlock-item .wiki-link {
            color: #6a9fd4;
            font-size: 11px;
            margin-left: 8px;
        }
        .unlock-item .wiki-link:hover {
            color: #8bb8e8;
        }

    </style>
</head>
<body>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
        <div>
            <h1 class="mb-0">RAID PLANNER <span style="font-size: 0.5em; vertical-align: middle; color: #888;">v1.3 Leaflet PoC</span></h1>
            <small class="text-sub">Interactive Map System - Proof of Concept</small>
        </div>
    </div>

    <div class="card p-4 mb-4">
        <div class="row g-3">
            <div class="col-md-5">
                <label class="text-beige small mb-1 fw-bold text-uppercase">Operational Area</label>
                <select id="mapSelect" class="form-select" onchange="applyFilters()">
                    <option value="Customs" selected>Customs (PoC Map)</option>
                    <option value="Factory" disabled>Factory (Coming Soon)</option>
                    <option value="Woods" disabled>Woods (Coming Soon)</option>
                    <option value="Interchange" disabled>Interchange (Coming Soon)</option>
                    <option value="Shoreline" disabled>Shoreline (Coming Soon)</option>
                    <option value="Reserve" disabled>Reserve (Coming Soon)</option>
                    <option value="Lighthouse" disabled>Lighthouse (Coming Soon)</option>
                    <option value="Streets of Tarkov" disabled>Streets of Tarkov (Coming Soon)</option>
                    <option value="Ground Zero" disabled>Ground Zero (Coming Soon)</option>
                    <option value="Labs" disabled>The Lab (Coming Soon)</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button onclick="loadAllQuests()" id="btn-load" class="btn btn-tarkov w-100">Load Operations</button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center d-none my-5">
        <div class="spinner-border text-secondary" role="status"></div>
        <p class="mt-2 text-beige">Retrieving Global Intelligence...</p>
    </div>
    <div id="error-box" class="alert alert-danger d-none rounded-0 border-danger"></div>

    <div id="quest-selection-area" class="d-none">
        <div class="mb-3">
            <input type="text" id="questSearch" class="form-control" placeholder="Search quests (e.g. 'Checking', 'Delivery')...">
        </div>

        <div class="d-flex justify-content-between align-items-end mb-3">
            <h5 class="m-0 text-beige">Select Active Tasks</h5>
            <div>
                <button onclick="clearSelection()" class="btn btn-tarkov btn-reset me-2 btn-sm">Reset</button>
                <button onclick="planRaid()" id="btn-initialize" class="btn btn-tarkov px-4">Initialize Plan</button>
            </div>
        </div>
        
        <div id="quest-list" class="accordion" id="questAccordion"></div>
    </div>

    <div id="planning-result">
        <h4 class="mb-3">Tactical Overview</h4>
        
        <!-- Layer Legend -->
        <div class="layer-legend">
            <div class="legend-item">
                <div class="legend-dot legend-quest"></div>
                <span style="color: var(--eft-beige);">Quest Objectives</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-extract"></div>
                <span style="color: var(--eft-green);">Extraction Points</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-loot"></div>
                <span style="color: var(--eft-blue);">Loot Locations</span>
            </div>
        </div>
        
        <!-- Leaflet Map Container -->
        <div style="position: relative;">
            <div id="map"></div>
            <div id="coords-display">X: 0 | Y: 0</div>
        </div>

        <div class="row mt-5">
            <div class="col-md-6">
                <div class="section-header">Required Keys</div>
                <div id="required-keys" class="d-flex flex-wrap"></div>
            </div>
            <div class="col-md-6">
                <div class="section-header">Required Items</div>
                <div id="required-items" class="d-flex flex-wrap"></div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-md-7">
                <div class="section-header">Operational Objectives</div>
                <ul id="mission-steps" class="list-group list-group-flush" style="border-left: 2px solid #333; padding-left: 10px;"></ul>
            </div>
            <div class="col-md-5">
                <div class="section-header" style="color: #a29bfe;">Intel: Unlocks</div>
                <div id="progression-list" class="small"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // ============================================================
    // CONFIGURATION
    // ============================================================
    
    let API_PREFIX = "/api"; 
    const STORAGE_KEY = "tarkov_planner_selected_quests"; 
    const WIKI_BASE_URL = "https://escapefromtarkov.fandom.com/wiki/";
    
    let allQuestsGlobal = []; 
    let mapInstance = null;
    
    // Layer Groups f√ºr verschiedene Marker-Typen
    let questMarkersLayer = L.layerGroup();
    let extractMarkersLayer = L.layerGroup();
    let lootMarkersLayer = L.layerGroup();

    // ============================================================
    // MAP CONFIGURATION - Mehrere Fallback-URLs
    // ============================================================
    
    const MAP_CONFIG = {
        "Customs": { 
            // Mehrere URLs als Fallback
            urls: [
                "https://static.wikia.nocookie.net/escapefromtarkov_gamepedia/images/5/5a/Customs_Map_-_Tutorial_Labels.png",
                "https://i.imgur.com/QXqXQXq.jpg", // Fallback placeholder
            ],
            // Gesch√§tzte Bildgr√∂√üe f√ºr die Wiki-Map
            width: 4096,  
            height: 2289,
            defaultZoom: -1,
            minZoom: -2,
            maxZoom: 2
        }
    };

    // ============================================================
    // QUEST KOORDINATEN DATABASE (Manuell gepflegt)
    // Koordinaten: [y, x] in Pixel (Leaflet Standard f√ºr CRS.Simple)
    // HINWEIS: Diese m√ºssen nach dem Map-Test angepasst werden!
    // ============================================================
    
    const QUEST_MARKERS = {
        // === CHECKING (Bronze Pocket Watch) ===
        "Checking": {
            questId: "596b36c586f77450d903a9d7",
            wikiLink: "Checking",
            markers: [
                {
                    id: "checking-truck",
                    coords: [1200, 2800],  // Angepasst f√ºr Wiki-Map
                    name: "Truck with Pocket Watch",
                    type: "objective",
                    description: "The truck cabin contains the bronze pocket watch. Look on the dashboard.",
                    hint: "The truck is in the construction area near the bridge. Key 205 opens the cabin door."
                },
                {
                    id: "checking-key-spawn",
                    coords: [900, 1200],
                    name: "Key 205 Spawn (Dorm 114)",
                    type: "key-location",
                    description: "Possible spawn location for the Dorm Room 205 Key.",
                    hint: "Check jackets and file cabinets in the dorms."
                }
            ]
        },
        
        // === DELIVERY FROM THE PAST ===
        "Delivery from the past": {
            questId: "5967530a86f77462ba22226b",
            wikiLink: "Delivery_from_the_past",
            markers: [
                {
                    id: "delivery-document",
                    coords: [950, 1400],
                    name: "Document Case",
                    type: "objective",
                    description: "Retrieve the secure case with documents from the dorms.",
                    hint: "Located in Room 206 on the second floor of 2-story dorms."
                }
            ]
        },
        
        // === BP DEPOT ===
        "BP Depot": {
            questId: "5969f9e986f7741dde183a50",
            wikiLink: "BP_Depot",
            markers: [
                {
                    id: "bp-tanker-1",
                    coords: [600, 2600],
                    name: "Fuel Tanker #1",
                    type: "objective",
                    description: "Place marker on first fuel tanker."
                },
                {
                    id: "bp-tanker-2", 
                    coords: [800, 2900],
                    name: "Fuel Tanker #2",
                    type: "objective",
                    description: "Place marker on second fuel tanker."
                },
                {
                    id: "bp-tanker-3",
                    coords: [1000, 3200],
                    name: "Fuel Tanker #3",
                    type: "objective",
                    description: "Place marker on third fuel tanker."
                },
                {
                    id: "bp-tanker-4",
                    coords: [1400, 3500],
                    name: "Fuel Tanker #4",
                    type: "objective", 
                    description: "Place marker on fourth fuel tanker."
                }
            ]
        }
    };

    // ============================================================
    // EXTRACT POINTS (Statische POIs f√ºr Customs)
    // ============================================================
    
    const EXTRACT_MARKERS = {
        "Customs": [
            { coords: [300, 600], name: "Crossroads", type: "extract-pmc" },
            { coords: [1800, 3800], name: "ZB-1011", type: "extract-pmc" },
            { coords: [1600, 3600], name: "Trailer Park", type: "extract-pmc" },
            { coords: [400, 3900], name: "RUAF Roadblock", type: "extract-conditional", hint: "Green smoke when active" },
            { coords: [1100, 2000], name: "Smuggler's Boat", type: "extract-conditional", hint: "Check for boat" },
            { coords: [200, 900], name: "Old Road Gate", type: "extract-pmc" },
            { coords: [1900, 3400], name: "ZB-1012", type: "extract-pmc", hint: "Requires key" }
        ]
    };

    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    function getSavedQuests() {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? new Set(JSON.parse(saved)) : new Set();
    }
    
    function saveQuestState(questId, isChecked) {
        const savedSet = getSavedQuests();
        if (isChecked) savedSet.add(questId); else savedSet.delete(questId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify([...savedSet]));
        updatePlanButton();
    }
    
    // Wiki-Link Generator
    function generateWikiLink(questName) {
        // Quest-Name zu Wiki-URL konvertieren
        const wikiSlug = questName.replace(/ /g, '_').replace(/['"]/g, '');
        return WIKI_BASE_URL + encodeURIComponent(wikiSlug);
    }

    // ============================================================
    // LEAFLET MAP INITIALIZATION MIT ERROR HANDLING
    // ============================================================
    
    function initMap(mapName) {
        const config = MAP_CONFIG[mapName];
        if (!config) {
            console.warn(`No map config for: ${mapName}`);
            showMapError("Map configuration not found for: " + mapName);
            return;
        }
        
        // Alte Map-Instanz entfernen
        if (mapInstance) {
            mapInstance.remove();
            mapInstance = null;
        }

        // Map Container leeren und Status entfernen
        const mapContainer = document.getElementById('map');
        
        // Leaflet Map mit CRS.Simple (Pixel-Koordinaten)
        mapInstance = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: config.minZoom,
            maxZoom: config.maxZoom,
            zoomSnap: 0.25,
            zoomDelta: 0.5,
            attributionControl: false,
            wheelPxPerZoomLevel: 120
        });

        // Bounds basierend auf Bildgr√∂√üe [y, x]
        const bounds = [[0, 0], [config.height, config.width]];
        
        // Map Image laden mit Error Handling
        loadMapImage(config.urls, bounds, config);
        
        // Layer Groups hinzuf√ºgen
        questMarkersLayer.addTo(mapInstance);
        extractMarkersLayer.addTo(mapInstance);
        lootMarkersLayer.addTo(mapInstance);
        
        // Layer Control
        const overlays = {
            "üìç Quest Objectives": questMarkersLayer,
            "üö™ Extraction Points": extractMarkersLayer,
            "üí∞ Loot Locations": lootMarkersLayer
        };
        
        L.control.layers(null, overlays, { 
            collapsed: false,
            position: 'topright'
        }).addTo(mapInstance);

        // Koordinaten-Anzeige bei Mausbewegung (Dev-Tool)
        mapInstance.on('mousemove', function(e) {
            const coordsDisplay = document.getElementById('coords-display');
            if (coordsDisplay) {
                coordsDisplay.innerHTML = `X: ${Math.round(e.latlng.lng)} | Y: ${Math.round(e.latlng.lat)}`;
            }
        });

        // Klick f√ºr Koordinaten-Kopie (Dev-Tool)
        mapInstance.on('click', function(e) {
            const coords = `[${Math.round(e.latlng.lat)}, ${Math.round(e.latlng.lng)}]`;
            console.log('Clicked coords:', coords);
            if (navigator.clipboard) {
                navigator.clipboard.writeText(coords).then(() => {
                    console.log('Coords copied to clipboard!');
                });
            }
        });

        setTimeout(() => mapInstance.invalidateSize(), 100);
    }
    
    // Map Image mit Fallbacks laden
    function loadMapImage(urls, bounds, config) {
        let currentIndex = 0;
        
        function tryLoadImage() {
            if (currentIndex >= urls.length) {
                showMapError("All map sources failed to load. Using placeholder.");
                // Placeholder anzeigen
                createPlaceholderMap(bounds, config);
                return;
            }
            
            const url = urls[currentIndex];
            console.log(`Trying to load map from: ${url}`);
            
            // Test ob Bild ladbar ist
            const img = new Image();
            img.crossOrigin = "anonymous";
            
            img.onload = function() {
                console.log(`Map loaded successfully from: ${url}`);
                console.log(`Image dimensions: ${img.width}x${img.height}`);
                
                // Tats√§chliche Bildgr√∂√üe verwenden
                const actualBounds = [[0, 0], [img.height, img.width]];
                
                L.imageOverlay(url, actualBounds).addTo(mapInstance);
                mapInstance.fitBounds(actualBounds);
                mapInstance.setZoom(config.defaultZoom);
                
                // Config aktualisieren f√ºr Marker
                config.width = img.width;
                config.height = img.height;
            };
            
            img.onerror = function() {
                console.warn(`Failed to load map from: ${url}`);
                currentIndex++;
                tryLoadImage();
            };
            
            img.src = url;
        }
        
        tryLoadImage();
    }
    
    // Placeholder Map wenn alle URLs fehlschlagen
    function createPlaceholderMap(bounds, config) {
        // Einfaches Grid als Placeholder
        mapInstance.fitBounds(bounds);
        mapInstance.setZoom(config.defaultZoom);
        
        // Grid-Linien als visuelle Hilfe
        for (let i = 0; i <= config.height; i += 500) {
            L.polyline([[i, 0], [i, config.width]], {color: '#333', weight: 1}).addTo(mapInstance);
        }
        for (let j = 0; j <= config.width; j += 500) {
            L.polyline([[0, j], [config.height, j]], {color: '#333', weight: 1}).addTo(mapInstance);
        }
        
        // Hinweis
        L.marker([config.height/2, config.width/2]).addTo(mapInstance)
            .bindPopup('<b>Map Loading Failed</b><br>Markers are still functional.')
            .openPopup();
    }
    
    function showMapError(message) {
        console.error(message);
    }

    // ============================================================
    // MARKER DRAWING
    // ============================================================
    
    function createQuestMarker(point, questName, questWikiLink) {
        let color = '#d2c4a6';
        let fillColor = '#000';
        
        if (point.type === 'key-location') {
            color = '#9e8f6b';
            fillColor = '#1a1a00';
        }
        
        const marker = L.circleMarker(point.coords, {
            radius: 10,
            color: color,
            fillColor: fillColor,
            fillOpacity: 0.9,
            weight: 3
        });

        const wikiUrl = questWikiLink ? WIKI_BASE_URL + questWikiLink : generateWikiLink(questName);
        
        const popupContent = `
            <div class="popup-quest-name">
                <a href="${wikiUrl}" target="_blank" style="color: #9e8f6b; text-decoration: none;">
                    ${questName} üîó
                </a>
            </div>
            <div class="popup-title">${point.name}</div>
            <div class="popup-desc">${point.description}</div>
            ${point.hint ? `<div class="popup-hint">üí° ${point.hint}</div>` : ''}
        `;
        
        marker.bindPopup(popupContent, {
            maxWidth: 320,
            className: 'custom-popup'
        });

        marker.bindTooltip(point.name, {
            permanent: true,
            direction: 'top',
            offset: [0, -12],
            className: 'marker-label marker-label-quest'
        });

        return marker;
    }

    function createExtractMarker(point) {
        let color = '#5a8c5a';
        
        if (point.type === 'extract-conditional') {
            color = '#8c8c5a';
        }
        
        const marker = L.circleMarker(point.coords, {
            radius: 8,
            color: color,
            fillColor: '#000',
            fillOpacity: 0.9,
            weight: 2
        });

        marker.bindPopup(`
            <div class="popup-title" style="color: ${color};">${point.name}</div>
            <div class="popup-desc">${point.hint || 'Extraction point'}</div>
        `);

        marker.bindTooltip(point.name, {
            permanent: false,
            direction: 'top',
            offset: [0, -10],
            className: 'marker-label marker-label-extract'
        });

        return marker;
    }

    function drawMarkersForQuests(selectedQuests, mapName) {
        questMarkersLayer.clearLayers();
        extractMarkersLayer.clearLayers();
        lootMarkersLayer.clearLayers();

        // Quest Markers
        selectedQuests.forEach(quest => {
            const questData = QUEST_MARKERS[quest.name];
            if (questData && questData.markers) {
                questData.markers.forEach(point => {
                    const marker = createQuestMarker(point, quest.name, questData.wikiLink);
                    questMarkersLayer.addLayer(marker);
                });
            }
        });

        // Extract Markers
        const extracts = EXTRACT_MARKERS[mapName];
        if (extracts) {
            extracts.forEach(point => {
                const marker = createExtractMarker(point);
                extractMarkersLayer.addLayer(marker);
            });
        }

        console.log(`Drawn ${questMarkersLayer.getLayers().length} quest markers`);
        console.log(`Drawn ${extractMarkersLayer.getLayers().length} extract markers`);
    }

    // ============================================================
    // FILTER & UI LOGIC
    // ============================================================
    
    document.getElementById('questSearch').addEventListener('input', applyFilters);

    function applyFilters() {
        const term = document.getElementById('questSearch').value.toLowerCase();
        const selectedMap = document.getElementById('mapSelect').value;
        let filtered = [];

        if (term.length > 0) {
            filtered = allQuestsGlobal.filter(q => q.name.toLowerCase().includes(term));
        } else {
            filtered = allQuestsGlobal.filter(q => {
                const qMap = q.map ? q.map.name : "Any";
                return (selectedMap === "Any") ? (qMap === "Any" || !q.map) : (qMap === selectedMap || qMap === "Any" || !q.map);
            });
        }
        renderQuestList(filtered);
    }

    function updatePlanButton() {
        const count = getSavedQuests().size;
        const btn = document.getElementById('btn-initialize');
        if(btn) btn.innerHTML = count > 0 ? `Initialize Plan (${count})` : "Initialize Plan";
    }

    function clearSelection() {
        if(confirm("Reset mission parameters?")) {
            localStorage.removeItem(STORAGE_KEY);
            document.querySelectorAll('.quest-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.quest-item').forEach(div => div.classList.remove('selected'));
            document.getElementById('planning-result').style.display = 'none';
            document.getElementById('questSearch').value = '';
            applyFilters();
            updatePlanButton();
        }
    }

    // ============================================================
    // API LOADING
    // ============================================================
    
    async function tryFetchQuests() {
        const pathsToTest = ["/api/quests/ALL", "/quests/ALL"];

        for (const path of pathsToTest) {
            console.log(`Trying: ${path}`);
            try {
                const response = await fetch(path);
                if (response.ok) {
                    API_PREFIX = path.includes("/api") ? "/api" : "";
                    return await response.json();
                }
            } catch (e) {
                console.warn(`Network error at ${path}:`, e);
            }
        }
        throw new Error("Backend connection failed. Check Docker containers.");
    }

    async function loadAllQuests() {
        const loader = document.getElementById('loading');
        const selectionArea = document.getElementById('quest-selection-area');
        const btnLoad = document.getElementById('btn-load');
        const errBox = document.getElementById('error-box');
        
        selectionArea.classList.add('d-none');
        document.getElementById('planning-result').style.display = 'none';
        loader.classList.remove('d-none');
        errBox.classList.add('d-none');

        try {
            allQuestsGlobal = await tryFetchQuests();

            if (allQuestsGlobal.length === 0) {
                document.getElementById('quest-list').innerHTML = '<div class="text-center text-sub p-4">No quests received.</div>';
            } else {
                applyFilters();
                selectionArea.classList.remove('d-none');
                btnLoad.innerHTML = "Reload Operations";
                btnLoad.classList.remove('btn-tarkov');
                btnLoad.classList.add('btn-secondary');
            }
        } catch (error) {
            errBox.innerHTML = `<strong>ERROR:</strong> ${error.message}`;
            errBox.classList.remove('d-none');
        } finally {
            loader.classList.add('d-none');
        }
    }

    // ============================================================
    // QUEST LIST RENDERING
    // ============================================================
    
    function renderQuestList(questsToRender) {
        const listContainer = document.getElementById('quest-list');
        listContainer.innerHTML = '';
        const savedSet = getSavedQuests();
        const isFiltering = document.getElementById('questSearch').value.length > 0;
        updatePlanButton();

        const groups = {};
        const standalone = [];
        
        questsToRender.forEach(quest => {
            const match = quest.name.match(/^(.*?) - Part \d+$/);
            if (match) {
                const groupName = match[1];
                if (!groups[groupName]) groups[groupName] = [];
                groups[groupName].push(quest);
            } else {
                standalone.push(quest);
            }
        });

        for (const [groupName, groupQuests] of Object.entries(groups)) {
            const groupId = groupName.replace(/[^a-zA-Z0-9]/g, '');
            const activeCount = groupQuests.filter(q => savedSet.has(q.id)).length;
            const hasActive = activeCount > 0;
            const shouldExpand = isFiltering || hasActive;

            const accordItem = document.createElement('div');
            accordItem.className = 'accordion-item';
            
            let groupHtml = `
                <h2 class="accordion-header" id="heading-${groupId}">
                    <button class="accordion-button ${shouldExpand ? '' : 'collapsed'}" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${groupId}"
                            id="btn-${groupId}" data-total="${groupQuests.length}">
                        ${groupName} 
                        <span class="badge-indicator ${hasActive ? 'badge-active' : 'badge-tarkov'} ms-2 px-2">
                            ${hasActive ? activeCount + ' Active' : groupQuests.length + ' Tasks'}
                        </span>
                    </button>
                </h2>
                <div id="collapse-${groupId}" class="accordion-collapse collapse ${shouldExpand ? 'show' : ''}">
                    <div class="accordion-body">
            `;
            groupQuests.forEach(q => groupHtml += createQuestItemHtml(q, savedSet, groupId));
            groupHtml += `</div></div>`;
            accordItem.innerHTML = groupHtml;
            listContainer.appendChild(accordItem);
        }

        if (standalone.length > 0) {
            const standaloneContainer = document.createElement('div');
            standaloneContainer.className = 'mt-3';
            standalone.forEach(q => standaloneContainer.innerHTML += createQuestItemHtml(q, savedSet, null));
            listContainer.appendChild(standaloneContainer);
        }
    }

    function createQuestItemHtml(quest, savedSet, groupId) {
        const isChecked = savedSet.has(quest.id);
        const groupAttr = groupId ? `data-parent-group="${groupId}"` : '';
        
        const hasCoords = QUEST_MARKERS[quest.name] !== undefined;
        const coordsIcon = hasCoords ? '<span style="color:#dca448; margin-right:5px;" title="Map markers available">üìç</span>' : '';

        return `
            <div class="quest-item d-flex align-items-center ${isChecked ? 'selected' : ''}" 
                 onclick="toggleSelection('${quest.id}', this, event)">
                <input class="form-check-input quest-checkbox" type="checkbox" id="cb-${quest.id}" 
                       value="${quest.id}" ${isChecked ? 'checked' : ''} ${groupAttr}
                       onchange="event.stopPropagation(); toggleSelection('${quest.id}', this.parentElement, event)">
                <div class="ms-3 flex-grow-1">
                    <div class="d-flex align-items-center">
                        ${coordsIcon}
                        <span class="fw-bold" style="color:#e0e0e0;">${quest.name}</span>
                        ${quest.wikiLink ? `<a href="${quest.wikiLink}" target="_blank" class="ms-2 text-sub small" style="text-decoration:none;" onclick="event.stopPropagation()">[Wiki]</a>` : ''}
                    </div>
                    <div class="mt-1 d-flex justify-content-between" style="font-size:0.8em; color:#bbb;">
                        <span>${quest.trader.name}</span>
                        <span>Lvl ${quest.minPlayerLevel}</span>
                        <span style="color:#888;">${quest.map ? quest.map.name : 'Global'}</span>
                    </div>
                </div>
            </div>
        `;
    }

    function toggleSelection(questId, divElement, event) {
        const checkbox = document.getElementById(`cb-${questId}`);
        if (event.target !== checkbox && event.target.tagName !== 'A') {
            checkbox.checked = !checkbox.checked;
        }
        if (checkbox.checked) divElement.classList.add('selected');
        else divElement.classList.remove('selected');
        saveQuestState(questId, checkbox.checked);
        
        const groupId = checkbox.getAttribute('data-parent-group');
        if (groupId) {
            const btn = document.getElementById(`btn-${groupId}`);
            const count = document.querySelectorAll(`input[data-parent-group="${groupId}"]:checked`).length;
            const badge = btn.querySelector('.badge-indicator');
            badge.textContent = count > 0 ? `${count} Active` : `${btn.dataset.total} Tasks`;
            badge.className = `badge-indicator ${count > 0 ? 'badge-active' : 'badge-tarkov'} ms-2 px-2`;
        }
    }

    // ============================================================
    // PLAN RAID - Hauptfunktion
    // ============================================================
    
    function planRaid() {
        const resultBox = document.getElementById('planning-result');
        const mapName = document.getElementById('mapSelect').value;
        const savedSet = getSavedQuests();

        if (savedSet.size === 0) { 
            alert("No operations selected."); 
            return; 
        }

        const selectedQuests = allQuestsGlobal.filter(q => savedSet.has(q.id));

        resultBox.style.display = 'block';
        resultBox.scrollIntoView({ behavior: 'smooth' });

        initMap(mapName);
        drawMarkersForQuests(selectedQuests, mapName);

        // Items & Keys aggregieren
        const neededKeys = new Map();
        const itemsMap = new Map();
        const objectives = [];
        const unlocks = [];

        selectedQuests.forEach(quest => {
            if (quest.neededKeys) {
                quest.neededKeys.forEach(g => {
                    if(g.keys && g.keys.length > 0) {
                        neededKeys.set(g.keys[0].name, g.keys[0]);
                    }
                });
            }
            if (quest.objectives) {
                quest.objectives.forEach(obj => {
                    objectives.push({ quest: quest.name, desc: obj.description });
                    let item = obj.item || obj.markerItem;
                    if (item) {
                        if (!itemsMap.has(item.id)) {
                            itemsMap.set(item.id, { name: item.name, icon: item.iconLink, count: 0 });
                        }
                        itemsMap.get(item.id).count += (obj.count || 1);
                    }
                });
            }
            if (quest.derived_unlocks) {
                quest.derived_unlocks.forEach(u => {
                    unlocks.push({ 
                        from: quest.name, 
                        nextName: u.name, 
                        nextMap: u.map, 
                        trader: u.trader,
                        wikiLink: u.wikiLink || generateWikiLink(u.name)
                    });
                });
            }
        });

        // UI Updates
        document.getElementById('required-keys').innerHTML = neededKeys.size > 0 
            ? Array.from(neededKeys.values()).map(k => 
                `<div class="item-box">${k.iconLink ? `<img src="${k.iconLink}">` : ''}<span>${k.shortName || k.name}</span></div>`
              ).join('') 
            : '<span class="text-sub p-2">None required.</span>';

        document.getElementById('required-items').innerHTML = itemsMap.size > 0 
            ? Array.from(itemsMap.values()).map(i => 
                `<div class="item-box status-acquire">${i.icon ? `<img src="${i.icon}">` : ''}<div>${i.count}x ${i.name}</div></div>`
              ).join('') 
            : '<span class="text-sub p-2">None required.</span>';

        document.getElementById('mission-steps').innerHTML = objectives.map(obj => 
            `<li class="list-group-item bg-transparent text-light border-0 ps-0">
                <span class="text-beige fw-bold">${obj.quest}:</span> 
                <span style="color:#bbb;">${obj.desc}</span>
            </li>`
        ).join('');

        // UNLOCKS MIT WIKI-LINKS
        document.getElementById('progression-list').innerHTML = unlocks.length > 0 
            ? unlocks.map(u => {
                const wikiUrl = generateWikiLink(u.nextName);
                return `
                <div class="unlock-item">
                    <div style="font-size: 0.85em; color:#777;">From ${u.from}:</div>
                    <div class="d-flex align-items-center">
                        <a href="${wikiUrl}" target="_blank" title="Open Wiki">‚ûî ${u.nextName}</a>
                        <a href="${wikiUrl}" target="_blank" class="wiki-link" title="EFT Wiki">[Wiki]</a>
                    </div>
                    <div class="small text-muted">${u.nextMap} | ${u.trader}</div>
                </div>`;
              }).join('')
            : '<div class="text-sub p-2 fst-italic">No immediate unlocks.</div>';
    }

    // ============================================================
    // INIT
    // ============================================================
    
    document.addEventListener('DOMContentLoaded', () => {
        updatePlanButton();
    });
</script>
</body>
</html>
