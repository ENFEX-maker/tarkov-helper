
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarkov Raid Planner v3.4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --bg-black: #0a0a0a; --bg-dark: #0e0e0e; --bg-panel: #121212; --bg-element: #1a1a1a; --bg-hover: #252525; --border-dark: #2a2a2a; --border-gold: #9e8f6b; --text-main: #d0d0d0; --text-sub: #888; --text-beige: #d2c4a6; --eft-gold: #9e8f6b; --eft-gold-bright: #c4b896; --eft-red: #8c3b3b; --eft-green: #4a7a4a; --eft-blue: #4a6a8a; --tier-s: #ffd700; --tier-a: #c0c0c0; --tier-b: #cd7f32; --tier-c: #5a9e5a; --tier-d: #5a7a9e; --tier-f: #9e5a5a; }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-black); color: var(--text-main); font-family: 'Rajdhani', 'Segoe UI', sans-serif; font-size: 0.95rem; line-height: 1.5; min-height: 100vh; }
        h1, h2, h3, h4, h5 { color: var(--text-beige); font-family: 'Rajdhani', sans-serif; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; }
        .text-beige { color: var(--text-beige) !important; } .text-sub { color: var(--text-sub) !important; } .text-gold { color: var(--eft-gold) !important; }
        .container { max-width: 1500px; margin-top: 20px; }
        .nav-tabs-tarkov { border-bottom: 2px solid var(--border-gold); margin-bottom: 30px; display: flex; gap: 0; }
        .nav-tab { background: var(--bg-panel); border: 1px solid var(--border-dark); border-bottom: none; color: var(--text-sub); padding: 15px 40px; font-family: 'Rajdhani', sans-serif; font-size: 1.1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: all 0.2s ease; position: relative; top: 2px; }
        .nav-tab:hover { background: var(--bg-element); color: var(--text-beige); }
        .nav-tab.active { background: var(--bg-dark); color: var(--text-beige); border-color: var(--border-gold); border-bottom: 2px solid var(--bg-dark); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .tarkov-panel { background: var(--bg-panel); border: 1px solid var(--border-dark); border-radius: 0; padding: 20px; margin-bottom: 20px; }
        .tarkov-panel h5 { border-bottom: 1px solid var(--border-gold); padding-bottom: 10px; margin-bottom: 15px; font-size: 1rem; }
        .btn-tarkov { background: linear-gradient(180deg, var(--bg-element) 0%, var(--bg-dark) 100%); border: 1px solid var(--border-gold); color: var(--text-beige); font-family: 'Rajdhani', sans-serif; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; padding: 10px 20px; transition: all 0.2s ease; }
        .btn-tarkov:hover { background: linear-gradient(180deg, var(--bg-hover) 0%, var(--bg-element) 100%); color: var(--eft-gold-bright); border-color: var(--eft-gold-bright); }
        .btn-tarkov:disabled { opacity: 0.5; cursor: not-allowed; }
        .trader-group { background: var(--bg-element); border: 1px solid var(--border-dark); margin-bottom: 10px; }
        .trader-header { display: flex; align-items: center; gap: 15px; padding: 15px; cursor: pointer; transition: background 0.2s; }
        .trader-header:hover { background: var(--bg-hover); }
        .trader-header img { width: 50px; height: 50px; border-radius: 0; border: 1px solid var(--border-gold); }
        .trader-header h6 { margin: 0; font-size: 1.1rem; flex-grow: 1; }
        .trader-quests { display: none; padding: 0 15px 15px; }
        .trader-quests.show { display: block; }
        .quest-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border-dark); margin-bottom: 6px; cursor: pointer; transition: all 0.15s ease; }
        .quest-row:hover { background: var(--bg-hover); border-color: var(--eft-gold); }
        .quest-row.selected { background: rgba(158, 143, 107, 0.15); border-color: var(--eft-gold); }
        .quest-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--eft-gold); cursor: pointer; flex-shrink: 0; }
        .quest-info { flex-grow: 1; min-width: 0; }
        .quest-name { font-weight: 600; color: var(--text-beige); font-size: 0.95rem; }
        .quest-name a { color: inherit; text-decoration: none; }
        .quest-name a:hover { text-decoration: underline; color: var(--eft-gold-bright); }
        .quest-meta { font-size: 0.8rem; color: var(--text-sub); display: flex; gap: 15px; flex-wrap: wrap; }
        .badge-tarkov { background: var(--bg-element); border: 1px solid var(--border-dark); color: var(--text-sub); padding: 4px 10px; font-size: 0.75rem; font-weight: 600; }
        .badge-active { background: rgba(158, 143, 107, 0.2); border-color: var(--eft-gold); color: var(--eft-gold); }
        .form-select-tarkov, .form-control-tarkov { background: var(--bg-element); border: 1px solid var(--border-dark); color: var(--text-main); padding: 10px 15px; font-family: 'Rajdhani', sans-serif; }
        .form-select-tarkov:focus, .form-control-tarkov:focus { background: var(--bg-hover); border-color: var(--eft-gold); color: var(--text-main); box-shadow: none; outline: none; }
        .form-select-tarkov option { background: var(--bg-dark); color: var(--text-main); }
        #map { height: 600px; background: var(--bg-dark); border: 1px solid var(--border-dark); }
        .map-controls { display: flex; align-items: center; gap: 15px; padding: 10px 15px; background: var(--bg-element); border: 1px solid var(--border-dark); border-bottom: none; font-size: 0.85rem; color: var(--text-sub); }
        .map-controls .btn-tarkov { padding: 5px 12px; font-size: 0.8rem; }
        .leaflet-container { background: var(--bg-dark); }
        .marker-label { background: rgba(0,0,0,0.85) !important; border: 1px solid var(--eft-gold) !important; color: var(--text-beige) !important; font-family: 'Rajdhani', sans-serif !important; padding: 5px 10px !important; border-radius: 0 !important; }
        .quest-marker-popup { min-width: 200px; }
        .quest-marker-popup h6 { color: var(--eft-gold); margin-bottom: 8px; font-size: 0.9rem; }
        .quest-marker-popup p { margin: 0; font-size: 0.85rem; color: var(--text-main); }
        .quest-marker-popup .obj-type { display: inline-block; padding: 2px 8px; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 5px; }
        .obj-pickup { background: #2d5a2d; color: #7fff7f; }
        .obj-place { background: #5a5a2d; color: #ffff7f; }
        .obj-mark { background: #5a2d5a; color: #ff7fff; }
        .obj-find { background: #2d5a5a; color: #7fffff; }
        .obj-kill { background: #5a2d2d; color: #ff7f7f; }
        .obj-locate { background: #2d2d5a; color: #7f7fff; }
        .item-box { display: flex; align-items: center; gap: 10px; background: var(--bg-dark); border: 1px solid var(--border-dark); padding: 8px 12px; margin-bottom: 6px; }
        .item-box img { width: 40px; height: 40px; object-fit: contain; }
        .item-label { font-size: 0.65rem; padding: 2px 6px; font-weight: 700; letter-spacing: 1px; }
        .label-find { background: var(--eft-red); color: #fff; }
        .label-given { background: var(--eft-green); color: #fff; }
        .status-provided { border-left: 3px solid var(--eft-green); }
        .status-acquire { border-left: 3px solid var(--eft-red); }
        .unlock-card { background: var(--bg-dark); border: 1px solid var(--border-dark); padding: 12px; margin-bottom: 8px; }
        .unlock-link { color: var(--eft-gold); text-decoration: none; }
        .unlock-link:hover { color: var(--eft-gold-bright); text-decoration: underline; }
        .caliber-group { margin-bottom: 20px; }
        .caliber-header { background: var(--bg-element); border: 1px solid var(--border-dark); padding: 10px 15px; font-weight: 600; color: var(--text-beige); margin-bottom: 5px; }
        .ammo-card { display: flex; align-items: center; gap: 10px; background: var(--bg-dark); border: 1px solid var(--border-dark); padding: 10px 12px; margin-bottom: 4px; cursor: pointer; transition: all 0.15s ease; }
        .ammo-card:hover { background: var(--bg-hover); border-color: var(--eft-gold); }
        .ammo-card.owned { background: rgba(74, 122, 74, 0.15); border-color: var(--eft-green); }
        .ammo-card img { width: 45px; height: 45px; object-fit: contain; }
        .ammo-stats { display: flex; gap: 12px; font-size: 0.8rem; color: var(--text-sub); margin-top: 3px; }
        .stat-dmg { color: #e07050; }
        .stat-pen { color: #50a0e0; }
        .stat-price { color: var(--eft-gold); }
        .tier-badge { display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; font-weight: 700; font-size: 0.85rem; border-radius: 0; flex-shrink: 0; }
        .tier-S { background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%); color: #000; }
        .tier-A { background: linear-gradient(135deg, #e0e0e0 0%, #a0a0a0 100%); color: #000; }
        .tier-B { background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%); color: #fff; }
        .tier-C { background: linear-gradient(135deg, #5a9e5a 0%, #3a6e3a 100%); color: #fff; }
        .tier-D { background: linear-gradient(135deg, #5a7a9e 0%, #3a5a7e 100%); color: #fff; }
        .tier-F { background: linear-gradient(135deg, #9e5a5a 0%, #7e3a3a 100%); color: #fff; }
        .analysis-panel { display: flex; gap: 20px; }
        .analysis-col { flex: 1; }
        .analysis-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--bg-element); border: 1px solid var(--border-dark); margin-bottom: 10px; }
        .analysis-header h6 { margin: 0; font-size: 0.9rem; }
        .analysis-list { max-height: 300px; overflow-y: auto; }
        .search-box { position: relative; margin-bottom: 15px; }
        .search-box input { width: 100%; padding-right: 35px; }
        .search-box::after { content: "üîç"; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        .loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: var(--text-sub); }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border-dark); border-top-color: var(--eft-gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .version-tag { position: fixed; bottom: 10px; right: 10px; font-size: 0.7rem; color: var(--text-sub); opacity: 0.5; }
        .quest-location-status { background: var(--bg-element); border: 1px solid var(--border-dark); padding: 10px 15px; margin-bottom: 15px; font-size: 0.85rem; }
        .quest-location-status .count { color: var(--eft-gold); font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4" style="font-size: 1.8rem;">‚öîÔ∏è Tarkov Raid Planner</h1>
        
        <div class="nav-tabs-tarkov">
            <div class="nav-tab active" onclick="switchTab('planner')">üìã Mission Planner</div>
            <div class="nav-tab" onclick="switchTab('ammo')">üéØ Ammo Manager</div>
        </div>

        <!-- MISSION PLANNER TAB -->
        <div id="tab-planner" class="tab-content active">
            <div class="row">
                <div class="col-lg-5">
                    <div class="tarkov-panel">
                        <h5>Select Operations</h5>
                        <div class="search-box">
                            <input type="text" class="form-control-tarkov w-100" placeholder="Search quests..." id="questSearch" oninput="filterQuests()">
                        </div>
                        <div id="quest-loading" class="loading-spinner">
                            <div class="spinner"></div>
                            <div>Loading intel from command...</div>
                        </div>
                        <div id="quest-list" class="d-none" style="max-height: 500px; overflow-y: auto;"></div>
                        <div id="quest-error" class="alert alert-danger d-none"></div>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="tarkov-panel">
                        <h5>Tactical Map</h5>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <select id="mapSelect" class="form-select-tarkov w-100" onchange="onMapChange()">
                                    <option value="customs">Customs</option>
                                    <option value="woods">Woods</option>
                                    <option value="shoreline">Shoreline</option>
                                    <option value="interchange">Interchange</option>
                                    <option value="reserve">Reserve</option>
                                    <option value="lighthouse">Lighthouse</option>
                                    <option value="streets">Streets of Tarkov</option>
                                    <option value="groundzero">Ground Zero</option>
                                    <option value="factory">Factory</option>
                                    <option value="labs">The Lab</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <button class="btn-tarkov w-100" onclick="planRaid()">‚ñ∂ Plan Raid</button>
                            </div>
                        </div>
                        <div class="quest-location-status" id="quest-loc-status">
                            üìç Quest Locations: <span class="count">Loading...</span>
                        </div>
                        <div class="map-controls">
                            <span>üñ±Ô∏è Scroll to zoom ‚Ä¢ Drag to pan ‚Ä¢ Click markers for details</span>
                            <button class="btn-tarkov ms-auto" onclick="resetMapView()">‚Ü∫ Reset View</button>
                        </div>
                        <div id="map"></div>
                    </div>
                </div>
            </div>

            <div id="planning-result" class="tarkov-panel" style="display: none;">
                <h5>üìã Mission Briefing</h5>
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-beige mb-3">üîë Required Keys</h6>
                        <div id="required-keys"></div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-beige mb-3">üì¶ Required Items</h6>
                        <div id="required-items"></div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-beige mb-3">üîì Unlocks</h6>
                        <div id="progression-list"></div>
                    </div>
                </div>
                <h6 class="text-beige mt-4 mb-3">üìù Objectives</h6>
                <ul id="mission-steps" class="list-group list-group-flush" style="max-height: 250px; overflow-y: auto;"></ul>
            </div>
        </div>

        <!-- AMMO MANAGER TAB -->
        <div id="tab-ammo" class="tab-content">
            <div class="row">
                <div class="col-lg-8">
                    <div class="tarkov-panel">
                        <h5>Ammunition Database</h5>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <select id="caliberFilter" class="form-select-tarkov w-100" onchange="filterAmmoByCaliber()">
                                    <option value="ALL">All Calibers</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <div class="search-box">
                                    <input type="text" class="form-control-tarkov w-100" placeholder="Search ammo..." id="ammoSearch" oninput="filterAmmoBySearch()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button id="btn-load-ammo" class="btn-tarkov w-100" onclick="loadAmmoData()">Load Data</button>
                            </div>
                        </div>
                        <div class="text-sub small mb-3">Click ammo to mark as owned ‚Ä¢ <span id="ammo-count">0</span> loaded</div>
                        <div id="ammo-loading" class="loading-spinner d-none">
                            <div class="spinner"></div>
                            <div>Loading ammunition data...</div>
                        </div>
                        <div id="ammo-content" class="d-none">
                            <div id="ammo-list" style="max-height: 500px; overflow-y: auto;"></div>
                        </div>
                        <div id="ammo-error" class="alert alert-danger d-none"></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="tarkov-panel">
                        <h5>Keep/Sell Analysis</h5>
                        <div class="mb-3">
                            <label class="form-label text-sub small">Minimum tier to keep:</label>
                            <input type="range" class="form-range" id="tierSlider" min="0" max="5" value="2" oninput="updateTierThreshold()">
                            <div class="text-center text-beige" id="tierDisplay">Keep B-Tier+</div>
                        </div>
                        <div class="analysis-panel" style="flex-direction: column;">
                            <div class="analysis-col">
                                <div class="analysis-header" style="background: rgba(74, 122, 74, 0.2);">
                                    <h6 style="color: var(--eft-green);">‚úì KEEP</h6>
                                    <span class="badge-tarkov badge-active" id="keep-count">0</span>
                                </div>
                                <div id="keep-list" class="analysis-list"></div>
                            </div>
                            <div class="analysis-col">
                                <div class="analysis-header" style="background: rgba(140, 59, 59, 0.2);">
                                    <h6 style="color: var(--eft-red);">‚úó SELL</h6>
                                    <span class="badge-tarkov" id="sell-count">0</span>
                                </div>
                                <div id="sell-list" class="analysis-list"></div>
                                <div class="text-end mt-2 text-sub small">Total value: <span id="total-sell-value" class="text-gold">‚ÇΩ0</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="version-tag">v3.4 - tarkovdata integration</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        const API_BASE = '/api';
        const STORAGE_KEY_QUESTS = 'tarkov_planner_quests_v3';
        const STORAGE_KEY_AMMO = 'tarkov_planner_ammo_v3';
        
        // Local map images (Re3mr maps)
        const MAP_CONFIG = {
            customs:     { file: 'maps/customs.jpg' },
            woods:       { file: 'maps/woods.jpg' },
            shoreline:   { file: 'maps/shoreline.jpg' },
            interchange: { file: 'maps/interchange.jpg' },
            reserve:     { file: 'maps/reserve.jpg' },
            lighthouse:  { file: 'maps/lighthouse.jpg' },
            streets:     { file: 'maps/streets.jpg' },
            groundzero:  { file: 'maps/groundzero.jpg' },
            factory:     { file: 'maps/factory.jpg' },
            labs:        { file: 'maps/labs.jpg' }
        };
        
        // Map name mapping for tarkovdata
        const MAP_NAME_TO_KEY = {
            'Customs': 'customs',
            'Woods': 'woods',
            'Shoreline': 'shoreline',
            'Interchange': 'interchange',
            'Reserve': 'reserve',
            'Lighthouse': 'lighthouse',
            'Streets of Tarkov': 'streets',
            'Ground Zero': 'groundzero',
            'Factory': 'factory',
            'The Lab': 'labs',
            'Laboratory': 'labs'
        };

        // Tier configuration
        const TIER_NAMES = ['S', 'A', 'B', 'C', 'D', 'F'];
        const TIER_ORDER = ['S', 'A', 'B', 'C', 'D', 'F'];
        
        // State
        let mapInstance = null;
        let currentMapLayer = null;
        let imageBounds = null;
        let allQuestsGlobal = [];
        let allAmmoData = null;
        let ownedAmmo = new Set();
        let currentTierThreshold = 'B';
        let questLocationsData = null;
        let questMarkersLayer = null;
        let currentMapHeight = 0;
        let currentMapWidth = 0;

        // ============================================================================
        // TARKOVDATA INTEGRATION - Quest Locations
        // ============================================================================
        
        const TARKOVDATA_QUESTS_URL = 'https://raw.githubusercontent.com/TarkovTracker/tarkovdata/master/quests.json';
        
        async function loadQuestLocationsData() {
            try {
                const response = await fetch(TARKOVDATA_QUESTS_URL);
                if (!response.ok) throw new Error('Failed to load tarkovdata');
                const data = await response.json();
                
                // Parse quest locations from tarkovdata format
                questLocationsData = {};
                let totalLocations = 0;
                
                for (const [questId, quest] of Object.entries(data)) {
                    if (quest.objectives) {
                        quest.objectives.forEach(obj => {
                            if (obj.gps && obj.gps.leftPercent !== undefined && obj.gps.topPercent !== undefined) {
                                // Determine map from location field
                                const mapKey = getMapKeyFromLocation(obj.location, quest);
                                if (!mapKey) return;
                                
                                if (!questLocationsData[mapKey]) {
                                    questLocationsData[mapKey] = [];
                                }
                                
                                questLocationsData[mapKey].push({
                                    questId: questId,
                                    questName: quest.title || quest.name || `Quest ${questId}`,
                                    objectiveId: obj.id,
                                    type: obj.type || 'unknown',
                                    description: obj.target || obj.tool || `Objective ${obj.id}`,
                                    leftPercent: obj.gps.leftPercent,
                                    topPercent: obj.gps.topPercent,
                                    floor: obj.gps.floor || 'Ground_Level'
                                });
                                totalLocations++;
                            }
                        });
                    }
                }
                
                document.getElementById('quest-loc-status').innerHTML = 
                    `üìç Quest Locations: <span class="count">${totalLocations} objectives</span> loaded from tarkovdata`;
                
                console.log('Quest locations loaded:', questLocationsData);
                return questLocationsData;
            } catch (error) {
                console.error('Error loading quest locations:', error);
                document.getElementById('quest-loc-status').innerHTML = 
                    `üìç Quest Locations: <span style="color: var(--eft-red);">Failed to load</span>`;
                return null;
            }
        }
        
        function getMapKeyFromLocation(locationId, quest) {
            // tarkovdata uses numeric location IDs
            const locationMap = {
                0: 'customs',      // Customs
                1: 'factory',      // Factory
                2: 'woods',        // Woods
                3: 'shoreline',    // Shoreline
                4: 'interchange',  // Interchange
                5: 'lighthouse',   // Lighthouse
                6: 'reserve',      // Reserve
                7: 'labs',         // The Lab
                8: 'streets',      // Streets of Tarkov
                9: 'groundzero'    // Ground Zero
            };
            
            if (locationId !== undefined && locationMap[locationId]) {
                return locationMap[locationId];
            }
            
            // Try to get from quest's map field
            if (quest.location !== undefined && locationMap[quest.location]) {
                return locationMap[quest.location];
            }
            
            return null;
        }
        
        function drawQuestMarkers(mapKey, mapWidth, mapHeight) {
            if (!questMarkersLayer) {
                questMarkersLayer = L.layerGroup();
            }
            questMarkersLayer.clearLayers();
            
            if (!questLocationsData || !questLocationsData[mapKey]) {
                console.log('No quest locations for map:', mapKey);
                return;
            }
            
            const locations = questLocationsData[mapKey];
            console.log(`Drawing ${locations.length} quest markers for ${mapKey}`);
            
            locations.forEach(loc => {
                // Convert percent to pixel coordinates
                const pixelX = (loc.leftPercent / 100) * mapWidth;
                const pixelY = (loc.topPercent / 100) * mapHeight;
                
                // Leaflet uses [y, x] format with inverted Y for CRS.Simple
                const leafletY = mapHeight - pixelY;
                const leafletX = pixelX;
                
                // Determine marker color based on objective type
                const colors = {
                    'find': { fill: '#2d5a5a', border: '#7fffff' },
                    'pickup': { fill: '#2d5a2d', border: '#7fff7f' },
                    'place': { fill: '#5a5a2d', border: '#ffff7f' },
                    'mark': { fill: '#5a2d5a', border: '#ff7fff' },
                    'kill': { fill: '#5a2d2d', border: '#ff7f7f' },
                    'locate': { fill: '#2d2d5a', border: '#7f7fff' },
                    'key': { fill: '#5a4a2d', border: '#ffc07f' },
                    'skill': { fill: '#4a4a4a', border: '#c0c0c0' },
                    'reputation': { fill: '#2d4a5a', border: '#7fc0ff' },
                    'warning': { fill: '#5a3a2d', border: '#ff9f7f' },
                    'unknown': { fill: '#3a3a3a', border: '#909090' }
                };
                
                const typeKey = loc.type.toLowerCase();
                const color = colors[typeKey] || colors['unknown'];
                
                const marker = L.circleMarker([leafletY, leafletX], {
                    radius: 8,
                    color: color.border,
                    fillColor: color.fill,
                    fillOpacity: 0.9,
                    weight: 2
                });
                
                // Create popup content
                const typeClass = `obj-${typeKey}`;
                const popupContent = `
                    <div class="quest-marker-popup">
                        <span class="obj-type ${typeClass}">${loc.type}</span>
                        <h6>${loc.questName}</h6>
                        <p>${loc.description}</p>
                        ${loc.floor !== 'Ground_Level' ? `<p class="text-sub" style="font-size: 0.75rem; margin-top: 5px;">Floor: ${loc.floor}</p>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent, {
                    className: 'marker-label'
                });
                
                marker.bindTooltip(loc.questName, {
                    direction: 'top',
                    className: 'marker-label',
                    offset: [0, -8]
                });
                
                questMarkersLayer.addLayer(marker);
            });
            
            if (mapInstance) {
                questMarkersLayer.addTo(mapInstance);
            }
        }

        // ============================================================================
        // TAB NAVIGATION
        // ============================================================================
        
        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        // ============================================================================
        // QUEST MANAGEMENT
        // ============================================================================
        
        function getSavedQuests() {
            const saved = localStorage.getItem(STORAGE_KEY_QUESTS);
            return saved ? new Set(JSON.parse(saved)) : new Set();
        }
        
        function saveQuestState(questId, isSelected) {
            const saved = getSavedQuests();
            isSelected ? saved.add(questId) : saved.delete(questId);
            localStorage.setItem(STORAGE_KEY_QUESTS, JSON.stringify([...saved]));
        }
        
        function getWikiUrl(questName) {
            return 'https://escapefromtarkov.fandom.com/wiki/' + encodeURIComponent(questName.replace(/ /g, '_'));
        }
        
        async function loadQuests() {
            const loading = document.getElementById('quest-loading');
            const list = document.getElementById('quest-list');
            const error = document.getElementById('quest-error');
            
            try {
                const response = await fetch(API_BASE + '/quests/ALL');
                if (!response.ok) throw new Error('Server error: ' + response.status);
                const data = await response.json();
                
                allQuestsGlobal = data.quests || [];
                const savedQuests = getSavedQuests();
                
                // Group by trader
                const byTrader = {};
                allQuestsGlobal.forEach(q => {
                    const trader = q.trader?.name || 'Unknown';
                    if (!byTrader[trader]) byTrader[trader] = { quests: [], image: q.trader?.imageLink };
                    byTrader[trader].quests.push(q);
                });
                
                // Render
                let html = '';
                for (const [trader, data] of Object.entries(byTrader)) {
                    const groupId = 'trader-' + trader.replace(/\s+/g, '-');
                    html += `
                        <div class="trader-group">
                            <div class="trader-header" onclick="toggleTrader('${groupId}')" id="btn-${groupId}" data-total="${data.quests.length}">
                                ${data.image ? `<img src="${data.image}" alt="${trader}">` : ''}
                                <h6>${trader}</h6>
                                <span class="badge-tarkov">${data.quests.length} Tasks</span>
                            </div>
                            <div class="trader-quests" id="${groupId}">
                    `;
                    
                    data.quests.forEach(q => {
                        const isSelected = savedQuests.has(q.id);
                        html += `
                            <div class="quest-row ${isSelected ? 'selected' : ''}" onclick="toggleSelection('${q.id}', this, event)">
                                <input type="checkbox" id="cb-${q.id}" ${isSelected ? 'checked' : ''} data-parent-group="${groupId}">
                                <div class="quest-info">
                                    <div class="quest-name">
                                        <a href="${getWikiUrl(q.name)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">${q.name}</a>
                                    </div>
                                    <div class="quest-meta">
                                        <span>üìç ${q.map?.name || 'Any'}</span>
                                        <span>üìä Lvl ${q.minPlayerLevel || '?'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
                
                list.innerHTML = html;
                list.classList.remove('d-none');
                loading.classList.add('d-none');
                
                // Update badge counts
                for (const [trader, data] of Object.entries(byTrader)) {
                    const groupId = 'trader-' + trader.replace(/\s+/g, '-');
                    updateTraderBadge(groupId);
                }
                
            } catch (err) {
                error.innerHTML = `<strong>ERROR:</strong> ${err.message}<br><small>Make sure the backend is running on ${API_BASE}</small>`;
                error.classList.remove('d-none');
                loading.classList.add('d-none');
            }
        }
        
        function toggleTrader(groupId) {
            document.getElementById(groupId).classList.toggle('show');
        }
        
        function toggleSelection(questId, div, ev) {
            const cb = document.getElementById('cb-' + questId);
            if (ev.target !== cb && ev.target.tagName !== 'A') {
                cb.checked = !cb.checked;
            }
            cb.checked ? div.classList.add('selected') : div.classList.remove('selected');
            saveQuestState(questId, cb.checked);
            
            const groupId = cb.getAttribute('data-parent-group');
            if (groupId) updateTraderBadge(groupId);
        }
        
        function updateTraderBadge(groupId) {
            const btn = document.getElementById('btn-' + groupId);
            if (!btn) return;
            const count = document.querySelectorAll(`input[data-parent-group="${groupId}"]:checked`).length;
            const badge = btn.querySelector('.badge-tarkov');
            badge.textContent = count > 0 ? count + ' Active' : btn.dataset.total + ' Tasks';
            badge.classList.toggle('badge-active', count > 0);
        }
        
        function filterQuests() {
            const search = document.getElementById('questSearch').value.toLowerCase();
            document.querySelectorAll('.quest-row').forEach(row => {
                const name = row.querySelector('.quest-name').textContent.toLowerCase();
                row.style.display = name.includes(search) ? '' : 'none';
            });
        }

        // ============================================================================
        // MAP MANAGEMENT
        // ============================================================================
        
        async function initMap(mapName) {
            const cfg = MAP_CONFIG[mapName];
            if (!cfg) return;
            
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            
            // Load image to get natural dimensions
            const img = new Image();
            img.src = cfg.file;
            
            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = () => {
                    document.getElementById('map').innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--eft-red);">
                            <div class="text-center">
                                <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                                <div>Map image not found: ${cfg.file}</div>
                            </div>
                        </div>
                    `;
                    reject(new Error('Image not found'));
                };
            });
            
            currentMapWidth = img.naturalWidth;
            currentMapHeight = img.naturalHeight;
            
            // Create map with image bounds
            imageBounds = [[0, 0], [currentMapHeight, currentMapWidth]];
            
            mapInstance = L.map('map', {
                crs: L.CRS.Simple,
                minZoom: -3,
                maxZoom: 2,
                zoomSnap: 0.25,
                zoomDelta: 0.5,
                attributionControl: false
            });
            
            currentMapLayer = L.imageOverlay(cfg.file, imageBounds).addTo(mapInstance);
            mapInstance.fitBounds(imageBounds);
            
            // Initialize quest markers layer
            questMarkersLayer = L.layerGroup().addTo(mapInstance);
            
            // Draw quest markers for this map
            drawQuestMarkers(mapName, currentMapWidth, currentMapHeight);
            
            setTimeout(() => mapInstance.invalidateSize(), 200);
        }
        
        function resetMapView() {
            if (mapInstance && imageBounds) {
                mapInstance.fitBounds(imageBounds);
            }
        }
        
        function onMapChange() {
            const mapName = document.getElementById('mapSelect').value;
            initMap(mapName);
        }

        // ============================================================================
        // RAID PLANNING
        // ============================================================================
        
        async function planRaid() {
            const resultBox = document.getElementById('planning-result');
            const mapName = document.getElementById('mapSelect').value;
            const savedQuests = getSavedQuests();
            
            if (savedQuests.size === 0) {
                alert('No operations selected. Please select at least one quest.');
                return;
            }
            
            const selectedQuests = allQuestsGlobal.filter(q => savedQuests.has(q.id));
            
            resultBox.style.display = 'block';
            resultBox.scrollIntoView({ behavior: 'smooth' });
            
            // Initialize map
            await initMap(mapName);
            
            // Collect items provided by quest starts
            const providedItemIds = new Set();
            selectedQuests.forEach(q => {
                if (q.startRewards?.items) {
                    q.startRewards.items.forEach(r => {
                        if (r.item?.id) providedItemIds.add(r.item.id);
                    });
                }
            });
            
            // Collect required keys, items, objectives, unlocks
            const neededKeys = new Map();
            const itemsMap = new Map();
            const objectives = [];
            const unlocks = [];
            
            selectedQuests.forEach(q => {
                // Keys
                if (q.neededKeys) {
                    q.neededKeys.forEach(g => {
                        if (g.keys?.length > 0) {
                            neededKeys.set(g.keys[0].name, g.keys[0]);
                        }
                    });
                }
                
                // Items and objectives
                if (q.objectives) {
                    q.objectives.forEach(o => {
                        objectives.push({ quest: q.name, desc: o.description });
                        
                        const item = o.item || o.markerItem;
                        if (item) {
                            const isProvided = providedItemIds.has(item.id);
                            if (!itemsMap.has(item.id)) {
                                itemsMap.set(item.id, { 
                                    name: item.name, 
                                    icon: item.iconLink, 
                                    count: 0, 
                                    isProvided 
                                });
                            }
                            itemsMap.get(item.id).count += (o.count || 1);
                            if (isProvided) itemsMap.get(item.id).isProvided = true;
                        }
                    });
                }
                
                // Unlocks
                if (q.derived_unlocks) {
                    q.derived_unlocks.forEach(u => unlocks.push({ from: q.name, ...u }));
                }
            });
            
            // Render keys
            document.getElementById('required-keys').innerHTML = neededKeys.size > 0 
                ? Array.from(neededKeys.values()).map(k => `
                    <div class="item-box">
                        ${k.iconLink ? `<img src="${k.iconLink}">` : ''}
                        <span>${k.shortName || k.name}</span>
                    </div>
                `).join('') 
                : '<span class="text-sub p-2">None required.</span>';
            
            // Render items (provided first)
            const itemsArray = Array.from(itemsMap.values())
                .sort((a, b) => (b.isProvided ? 1 : 0) - (a.isProvided ? 1 : 0));
            
            document.getElementById('required-items').innerHTML = itemsArray.length > 0 
                ? itemsArray.map(i => `
                    <div class="item-box ${i.isProvided ? 'status-provided' : 'status-acquire'}">
                        ${i.icon ? `<img src="${i.icon}">` : ''}
                        <div>${i.count}x ${i.name}</div>
                        <span class="item-label ${i.isProvided ? 'label-given' : 'label-find'}">
                            ${i.isProvided ? 'GIVEN' : 'FIND'}
                        </span>
                    </div>
                `).join('') 
                : '<span class="text-sub p-2">None required.</span>';
            
            // Render objectives
            document.getElementById('mission-steps').innerHTML = objectives.map(o => `
                <li class="list-group-item bg-transparent text-light border-0 ps-0 py-2">
                    <span class="text-beige fw-bold">${o.quest}:</span> 
                    <span style="color: var(--text-sub);">${o.desc}</span>
                </li>
            `).join('');
            
            // Render unlocks
            document.getElementById('progression-list').innerHTML = unlocks.length > 0 
                ? unlocks.map(u => `
                    <div class="unlock-card">
                        <div style="font-size: 0.8rem; color: var(--text-sub);">From ${u.from}:</div>
                        <div class="fw-bold">
                            ‚ûî <a href="${getWikiUrl(u.name)}" target="_blank" rel="noopener noreferrer" class="unlock-link">${u.name}</a>
                        </div>
                        <div class="small text-sub">${u.map} | ${u.trader}</div>
                    </div>
                `).join('') 
                : '<div class="text-sub p-2">No immediate unlocks.</div>';
        }

        // ============================================================================
        // AMMO MANAGEMENT
        // ============================================================================
        
        function loadSavedAmmo() {
            const saved = localStorage.getItem(STORAGE_KEY_AMMO);
            ownedAmmo = saved ? new Set(JSON.parse(saved)) : new Set();
        }
        
        function saveOwnedAmmo() {
            localStorage.setItem(STORAGE_KEY_AMMO, JSON.stringify([...ownedAmmo]));
        }
        
        async function loadAmmoData() {
            const loading = document.getElementById('ammo-loading');
            const content = document.getElementById('ammo-content');
            const error = document.getElementById('ammo-error');
            const btn = document.getElementById('btn-load-ammo');
            
            content.classList.add('d-none');
            loading.classList.remove('d-none');
            error.classList.add('d-none');
            
            try {
                const response = await fetch(API_BASE + '/ammo');
                if (!response.ok) throw new Error('Server error: ' + response.status);
                
                allAmmoData = await response.json();
                
                // Populate caliber dropdown
                const caliberSelect = document.getElementById('caliberFilter');
                caliberSelect.innerHTML = '<option value="ALL">All Calibers</option>';
                allAmmoData.calibers.forEach(cal => {
                    caliberSelect.innerHTML += `<option value="${cal}">${cal}</option>`;
                });
                
                document.getElementById('ammo-count').textContent = allAmmoData.all.length + ' types';
                renderAmmoList();
                
                content.classList.remove('d-none');
                btn.innerHTML = 'Refresh Data';
                btn.classList.add('btn-secondary');
                
            } catch (err) {
                error.innerHTML = `<strong>ERROR:</strong> ${err.message}`;
                error.classList.remove('d-none');
            } finally {
                loading.classList.add('d-none');
            }
        }
        
        function filterAmmoByCaliber() {
            renderAmmoList();
        }
        
        function filterAmmoBySearch() {
            renderAmmoList();
        }
        
        function updateTierThreshold() {
            const value = parseInt(document.getElementById('tierSlider').value);
            currentTierThreshold = TIER_NAMES[value];
            document.getElementById('tierDisplay').textContent = 'Keep ' + currentTierThreshold + '-Tier+';
            updateAmmoAnalysis();
        }
        
        function renderAmmoList() {
            if (!allAmmoData) return;
            
            const container = document.getElementById('ammo-list');
            const caliberFilter = document.getElementById('caliberFilter').value;
            const searchFilter = document.getElementById('ammoSearch').value.toLowerCase();
            
            let html = '';
            
            if (caliberFilter === 'ALL') {
                for (const [caliber, ammos] of Object.entries(allAmmoData.byCaliber)) {
                    const filtered = ammos.filter(a => 
                        a.name.toLowerCase().includes(searchFilter) || 
                        a.shortName.toLowerCase().includes(searchFilter)
                    );
                    if (filtered.length > 0) {
                        html += renderCaliberGroup(caliber, filtered);
                    }
                }
            } else {
                const ammos = allAmmoData.byCaliber[caliberFilter] || [];
                const filtered = ammos.filter(a => 
                    a.name.toLowerCase().includes(searchFilter) || 
                    a.shortName.toLowerCase().includes(searchFilter)
                );
                html += renderCaliberGroup(caliberFilter, filtered);
            }
            
            container.innerHTML = html;
            updateAmmoAnalysis();
        }
        
        function renderCaliberGroup(caliber, ammos) {
            let html = `
                <div class="caliber-group">
                    <div class="caliber-header">${caliber} <span class="text-sub small">(${ammos.length})</span></div>
            `;
            
            ammos.forEach(a => {
                const isOwned = ownedAmmo.has(a.id);
                html += `
                    <div class="ammo-card ${isOwned ? 'owned' : ''}" onclick="toggleAmmoOwned('${a.id}')">
                        <span class="tier-badge tier-${a.tier}">${a.tier}</span>
                        ${a.iconLink ? `<img src="${a.iconLink}">` : ''}
                        <div class="flex-grow-1">
                            <div class="fw-bold" style="color: var(--text-main);">${a.shortName}</div>
                            <div class="ammo-stats">
                                <span class="stat-dmg">üí• ${a.damage}</span>
                                <span class="stat-pen">üõ°Ô∏è ${a.penetration}</span>
                                ${a.sellPrice > 0 ? `<span class="stat-price">‚ÇΩ${a.sellPrice.toLocaleString()}</span>` : ''}
                            </div>
                        </div>
                        ${isOwned ? '<span class="badge-tarkov badge-active">OWNED</span>' : ''}
                    </div>
                `;
            });
            
            return html + '</div>';
        }
        
        function toggleAmmoOwned(id) {
            ownedAmmo.has(id) ? ownedAmmo.delete(id) : ownedAmmo.add(id);
            saveOwnedAmmo();
            renderAmmoList();
        }
        
        function updateAmmoAnalysis() {
            if (!allAmmoData) return;
            
            const keepList = document.getElementById('keep-list');
            const sellList = document.getElementById('sell-list');
            const keepCount = document.getElementById('keep-count');
            const sellCount = document.getElementById('sell-count');
            const totalValue = document.getElementById('total-sell-value');
            
            const tierIndex = TIER_ORDER.indexOf(currentTierThreshold);
            const keepTiers = TIER_ORDER.slice(tierIndex);
            
            const owned = allAmmoData.all.filter(a => ownedAmmo.has(a.id));
            const keep = owned.filter(a => keepTiers.includes(a.tier));
            const sell = owned.filter(a => !keepTiers.includes(a.tier));
            
            keepCount.textContent = keep.length;
            sellCount.textContent = sell.length;
            
            keepList.innerHTML = keep.length > 0 
                ? keep.map(a => renderAnalysisItem(a, 'keep')).join('') 
                : '<div class="text-sub p-2 small">No ammo to keep marked.</div>';
            
            sellList.innerHTML = sell.length > 0 
                ? sell.map(a => renderAnalysisItem(a, 'sell')).join('') 
                : '<div class="text-sub p-2 small">No ammo to sell.</div>';
            
            totalValue.textContent = '‚ÇΩ' + sell.reduce((sum, a) => sum + (a.sellPrice || 0), 0).toLocaleString();
        }
        
        function renderAnalysisItem(ammo, type) {
            return `
                <div class="item-box ${type === 'keep' ? 'status-provided' : 'status-acquire'} w-100 mb-1">
                    <span class="tier-badge tier-${ammo.tier}" style="width:24px;height:24px;line-height:24px;font-size:0.75rem;">${ammo.tier}</span>
                    ${ammo.iconLink ? `<img src="${ammo.iconLink}" style="width:28px;height:28px;">` : ''}
                    <div class="flex-grow-1">
                        <div style="font-size:0.85rem;">${ammo.shortName}</div>
                        <div style="font-size:0.7rem;color:var(--text-sub);">${ammo.caliber}</div>
                    </div>
                    ${type === 'sell' && ammo.sellPrice > 0 ? `<span class="stat-price small">‚ÇΩ${ammo.sellPrice.toLocaleString()}</span>` : ''}
                </div>
            `;
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            loadSavedAmmo();
            
            // Load quest locations from tarkovdata
            await loadQuestLocationsData();
            
            // Load quests from backend
            loadQuests();
            
            // Initialize map
            initMap('customs');
        });
    </script>
</body>
</html>
